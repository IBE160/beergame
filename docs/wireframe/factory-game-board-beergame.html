<!DOCTYPE html>
<html class="" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Beer Game - Factory Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

<!-- React & Recharts Dependencies -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
<script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        'mono-bg': '#1A1A1A', // Dark charcoal/black background
                        'mono-surface': '#2C2C2C', // Slightly lighter dark gray for cards/surfaces
                        'mono-text': '#E0E0E0', // Light gray for primary text
                        'mono-light': '#808080', // Medium gray for secondary text/borders
                        'accent': '#F97316', // Orange as the contrasting accent color (Factory)
                        'production': '#06B6D4', // Cyan for Production pipeline
                    },
                    fontFamily: {
                        sans: ["Inter", "system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "sans-serif"],
                        mono: ["Roboto Mono", "monospace"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem", // Sharper corners for a modern look
                        'sm': "0.125rem",
                        'md': "0.375rem",
                        'lg': "0.5rem",
                        'xl': "0.75rem",
                        'full': "9999px",
                    },
                    borderWidth: {
                        '1': '1px',
                    }
                },
            },
        };
    </script>
<style type="text/tailwindcss">body {
            @apply font-sans bg-mono-bg text-mono-text antialiased;
        }.flow-pipe {
            @apply absolute bg-mono-light opacity-50 transition-all duration-300 ease-out;
        }
        .flow-pipe.active {
            @apply bg-accent opacity-100;
        }
        .flow-pipe.vertical {
            @apply w-[2px] h-1/2;
        }
        .flow-pipe.horizontal {
            @apply h-[2px] w-1/2;
        }
        .flow-pipe.arrow-end::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            @apply opacity-0 transition-opacity duration-300 ease-out;
        }
        .flow-pipe.arrow-end.active::after {
             @apply opacity-100;
        }
        .flow-pipe.arrow-down::after {
            border-width: 6px 4px 0 4px;border-color: var(--tw-bg-accent) transparent transparent transparent;
            left: 50%;
            bottom: -6px;transform: translateX(-50%);
        }
        .flow-pipe.arrow-up::after {
            border-width: 0 4px 6px 4px;border-color: transparent transparent var(--tw-bg-accent) transparent;
            left: 50%;
            top: -6px;transform: translateX(-50%);
        }
        .flow-pipe.arrow-right::after {
            border-width: 4px 0 4px 6px;border-color: transparent transparent transparent var(--tw-bg-accent);
            top: 50%;
            right: -6px;transform: translateY(-50%);
        }
        .flow-pipe.arrow-left::after {
            border-width: 4px 6px 4px 0;border-color: transparent var(--tw-bg-accent) transparent transparent;
            top: 50%;
            left: -6px;transform: translateY(-50%);
        }
        /* Hide numeric spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="font-sans bg-mono-bg text-mono-text antialiased overflow-x-auto">
    <div class="w-full min-w-[400px] h-screen p-6 overflow-auto">
        <div class="flex-1 flex flex-col w-full max-w-[1600px] mx-auto relative z-10 space-y-6 px-6">

            <!-- MAIN GAME BOARD (Sketch Implementation) -->
            <div class="w-full bg-mono-surface/40 backdrop-blur-md border border-mono-light/10 rounded-2xl p-4 lg:p-6 lg:p-8 shadow-2xl flex flex-col-reverse lg:flex-row items-stretch lg:justify-between gap-4 lg:gap-0 relative overflow-hidden">

                <!-- 1. LEFT NODE: PRODUCTION -->
                <div class="w-full lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-20 group">
                    <!-- Header - hidden on mobile -->
                    <div class="hidden lg:block p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-sm uppercase tracking-widest font-bold text-center">Production</h3>
                    </div>

                    <!-- Mobile: Title (centered) in top row -->
                    <div class="lg:hidden p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Production</h3>
                    </div>

                    <!-- Content area with Week 1 and Week 2 boxes centered -->
                    <div class="flex-1 flex items-center justify-center p-3 lg:p-4 relative">
                         <!-- Faint background icon -->
                         <span class="material-symbols-outlined text-7xl lg:text-9xl text-mono-light/5 absolute opacity-[0.03] top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">precision_manufacturing</span>

                         <!-- Week boxes container - centered both vertically and horizontally -->
                         <div class="flex flex-row lg:flex-col items-center justify-center gap-4 z-10">
                             <!-- Week 2 (further from Factory) -->
                             <div id="mobile-production-week-2-box" class="lg:hidden bg-mono-surface border border-production/30 p-2 rounded shadow-lg">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                                <div id="mobile-production-week-2" class="bg-production/10 px-3 py-1 rounded border border-production/20 text-production font-sans font-bold text-center min-w-[55px]">30</div>
                            </div>
                             <!-- Week 1 (closer to Factory) -->
                             <div id="mobile-production-week-1-box" class="lg:hidden bg-mono-surface border border-production/30 p-2 rounded shadow-lg">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                                <div id="mobile-production-week-1" class="bg-production/10 px-3 py-1 rounded border border-production/20 text-production font-sans font-bold text-center min-w-[55px]">20</div>
                            </div>
                             <!-- Desktop Week boxes -->
                             <div class="hidden lg:block bg-mono-surface border border-production/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                                <div id="production-week-2" class="bg-production/10 px-3 py-1 rounded border border-production/20 text-production font-sans font-bold text-center min-w-[55px]">30</div>
                            </div>
                             <div class="hidden lg:block bg-mono-surface border border-production/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                                <div id="production-week-1" class="bg-production/10 px-3 py-1 rounded border border-production/20 text-production font-sans font-bold text-center min-w-[55px]">20</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PIPE SECTION 1: Production -> Factory (Hidden on mobile) -->
                <div class="hidden lg:flex flex-1 flex-col justify-between py-4 relative min-w-[200px]">
                    <!-- Top Pipe: Deliveries (Rightward) -->
                    <div class="relative h-16 top-[40px] w-full flex items-center">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 mt-[2px] h-[40px] bg-mono-surface rounded-none"></div>
                    </div>

                    <!-- Bottom Pipe: Orders (Leftward) -->
                    <div class="relative h-16 w-full flex items-center top-[5px]">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[40px] bg-mono-surface rounded-none"></div>
                    </div>
                </div>

                <!-- MOBILE VERTICAL CONNECTOR 1: Production -> Factory -->
                <div class="flex lg:hidden flex-row items-stretch justify-between w-full px-[calc(25%-60px)] -my-5 min-h-[200px]">
                    <!-- Left pipe - continuous (deliveries flowing down) -->
                    <div class="w-[70px] self-stretch bg-mono-surface"></div>
                    <!-- Right pipe - continuous (orders flowing up) -->
                    <div id="mobile-order-pipe-1" class="w-[70px] self-stretch bg-mono-surface"></div>
                </div>

                <!-- 2. CENTER NODE: INVENTORY (FACTORY) -->
                <div class="w-full lg:w-56 min-h-[250px] lg:min-h-0 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-30">
                    <!-- Mobile: Absolutely centered Inventory (pushed down to avoid overlap with Order) -->
                    <div id="factory-inventory-mobile" class="lg:hidden absolute left-1/2 top-[55%] -translate-x-1/2 -translate-y-1/2 bg-mono-bg/30 p-2 rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] min-h-[120px] z-20">
                        <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-10">Inventory</h4>
                        <div class="text-3xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">50</div>
                    </div>

                    <!-- Header - hidden on mobile -->
                    <div class="hidden lg:block p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-sm uppercase tracking-widest font-bold text-center">Factory</h3>
                    </div>

                    <!-- Mobile: Title (centered) + Order slot at top right -->
                    <div class="lg:hidden p-3 pb-0 relative">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Factory</h3>
                        <!-- Mobile Order Box - aligned with right pipe at top (incoming orders from Distributor) - GREEN (Distributor color) -->
                        <div class="absolute top-3 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-dashed border-violet-500/30 p-2 rounded shadow-lg z-10">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div class="mobile-factory-order-value bg-violet-500/10 px-3 py-1 rounded border border-violet-500/20 text-violet-400 font-sans font-bold text-center min-w-[55px]">&nbsp;</div>
                        </div>
                    </div>

                    <!-- Inventory Display (Wrapped Box) - Desktop only -->
                    <div class="hidden lg:flex flex-1 items-center justify-center pt-[34px] p-6">
                         <div id="factory-inventory" class="bg-mono-bg/30 p-4 mt-[15px] rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[120px] min-h-[100px]">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">50</div>
                        </div>
                    </div>
                    <!-- Mobile: Spacer to maintain layout -->
                    <div class="lg:hidden flex-1"></div>

                    <!-- Bottom Section: Order (Left) & Incoming Order (Right) - Hidden on mobile -->
                    <div class="hidden lg:flex p-4 bg-mono-surface rounded-b-xl justify-between items-end gap-2 relative">

                        <!-- Order Section with Send Button (tablet/desktop) -->
                        <div class="flex flex-col items-center gap-2">
                            <button id="btnSend" class="w-full bg-transparent border border-accent hover:bg-accent/10 text-white rounded py-1 shadow-md transition-colors flex items-center justify-center">
                                <span class="text-[10px] font-bold uppercase">Send</span>
                            </button>

                            <!-- Order Input (Numeric Up/Down) -->
                             <div class="bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform relative group">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div id="factory-order-value" class="bg-accent/10 px-1 py-0 rounded border border-accent/20 flex items-center justify-center min-w-[55px]">
                                    <input type="number" value="30" id="orderInput" min="0" class="w-6 bg-transparent text-center font-sans font-bold text-accent border-0 p-0 focus:ring-0 appearance-none" />
                                    <div class="flex flex-col ml-0.5">
                                        <button id="btnUp" class="text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_up</span></button>
                                        <button id="btnDown" class="text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_down</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Script for Order Input Logic & Animations -->
                        <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                // Desktop elements
                                const orderInput = document.getElementById('orderInput');
                                const btnUp = document.getElementById('btnUp');
                                const btnDown = document.getElementById('btnDown');
                                const btnSend = document.getElementById('btnSend');

                                // Mobile elements
                                const mobileOrderInput = document.querySelector('.mobile-order-input');
                                const mobileBtnUp = document.querySelector('.mobile-btn-up');
                                const mobileBtnDown = document.querySelector('.mobile-btn-down');
                                const mobileBtnSend = document.querySelector('.mobile-btn-send');
                                
                                // Note: Class selectors for mobile value boxes to ensure we target the value, not the container
                                const mobileFactoryOrder = document.querySelector('.mobile-factory-order-value');
                                const mobileDistributorOrder = document.querySelector('.mobile-distributor-order'); // Value box in Right Node
                                const mobileProductionOrder = document.querySelector('.mobile-production-order-value');

                                // --- Get Elements by ID ---
                                const els = {
                                    productionOrderInner: document.getElementById('production-order-value'),
                                    factoryOrderInner: document.getElementById('factory-order-value'),
                                    factoryInventory: document.getElementById('factory-inventory'),
                                    
                                    // Incoming Deliveries (from Production - Cyan/Blue)
                                    orangeWeek1: document.getElementById('delivery-week-1'), // Named orangeWeek1 in logic but holds Production delivery
                                    orangeWeek2: document.getElementById('delivery-week-2'),
                                    
                                    // Outgoing Deliveries (to Distributor - Orange/Accent)
                                    violetWeek1: document.getElementById('outgoing-week-1'), // Named violetWeek1 in logic but holds Factory delivery
                                    violetWeek2: document.getElementById('outgoing-week-2'),
                                    
                                    factoryOrderReceived: document.getElementById('factory-order-received'),
                                    factoryOrderReceivedInner: document.getElementById('factory-order-received-value'),
                                    
                                    distributorOrder: document.getElementById('distributor-order'),
                                    distributorInventory: document.getElementById('distributor-inventory'),
                                    productionInventory: document.getElementById('production-inventory'),
                                    
                                    // Mobile elements
                                    mobileDeliveryWeek1: document.getElementById('mobile-delivery-week-1'),
                                    mobileDeliveryWeek2: document.getElementById('mobile-delivery-week-2'),
                                    mobileDeliveryWeek1Box: document.getElementById('mobile-delivery-week-1-box'),
                                    mobileDeliveryWeek2Box: document.getElementById('mobile-delivery-week-2-box'),
                                    mobileOutgoingWeek1: document.getElementById('mobile-outgoing-week-1'),
                                    mobileOutgoingWeek2: document.getElementById('mobile-outgoing-week-2'),
                                    mobileOutgoingWeek1Box: document.getElementById('mobile-outgoing-week-1-box'),
                                    mobileOutgoingWeek2Box: document.getElementById('mobile-outgoing-week-2-box'),

                                    // Production Week boxes (inside Production node)
                                    mobileProductionWeek1: document.getElementById('mobile-production-week-1'),
                                    mobileProductionWeek2: document.getElementById('mobile-production-week-2'),
                                    mobileProductionWeek1Box: document.getElementById('mobile-production-week-1-box'),
                                    mobileProductionWeek2Box: document.getElementById('mobile-production-week-2-box')
                                };

                                // ========================================
                                // SHARED GAME STATE
                                // ========================================
                                const gameState = {
                                    // Configuration
                                    config: {
                                        productionInventory: 100,
                                        orderRange: { min: 10, max: 20 }
                                    },

                                    // Current values (shared between mobile/desktop)
                                    incomingOrder: 0,
                                    orderValue: 0,
                                    factoryInventory: 50,

                                    // Calculated delivery values
                                    productionDelivery: 0,
                                    factoryOutgoing: 0,

                                    // Week slot values
                                    // Production Week slots (inside Production node - Cyan)
                                    productionWeek1: 20,
                                    productionWeek2: 30,
                                    // Outgoing Week slots (Factory -> Distributor pipe - Orange)
                                    violetWeek1: 25,
                                    violetWeek2: 20,
                                    // Legacy aliases for compatibility
                                    get orangeWeek1() { return this.productionWeek1; },
                                    set orangeWeek1(v) { this.productionWeek1 = v; },
                                    get orangeWeek2() { return this.productionWeek2; },
                                    set orangeWeek2(v) { this.productionWeek2 = v; },

                                    // Phase 2 clone references (for Phase 3)
                                    phase2: {
                                        deliveryClone: null,
                                        outgoingClone: null
                                    },

                                    // Helper methods
                                    generateIncomingOrder() {
                                        const { min, max } = this.config.orderRange;
                                        this.incomingOrder = Math.floor(Math.random() * (max - min + 1)) + min;
                                        return this.incomingOrder;
                                    },

                                    calculateDelivery(available, requested) {
                                        return Math.min(Math.max(0, available), Math.max(0, requested));
                                    },

                                    processProductionOrder(orderValue) {
                                        this.orderValue = orderValue;
                                        this.productionDelivery = this.calculateDelivery(this.config.productionInventory, orderValue);
                                        return this.productionDelivery;
                                    },

                                    processFactoryOrder(orderValue) {
                                        this.factoryOutgoing = this.calculateDelivery(this.factoryInventory, orderValue);
                                        this.factoryInventory = Math.max(0, this.factoryInventory - orderValue);
                                        return { outgoing: this.factoryOutgoing, newInventory: this.factoryInventory };
                                    },

                                    receiveDelivery(amount) {
                                        this.factoryInventory += amount;
                                        return this.factoryInventory;
                                    },

                                    advanceWeeks() {
                                        // Incoming deliveries pipeline
                                        this.orangeWeek2 = this.orangeWeek1;
                                        this.orangeWeek1 = this.productionDelivery;
                                        // Outgoing deliveries pipeline
                                        this.violetWeek2 = this.violetWeek1;
                                        this.violetWeek1 = this.factoryOutgoing;
                                    }
                                };

                                // Sync gameState to all DOM elements
                                function syncStateToDOM() {
                                    // Factory inventory (both mobile and desktop)
                                    const desktopInv = els.factoryInventory?.querySelector('.text-5xl');
                                    const mobileInv = document.getElementById('factory-inventory-mobile')?.querySelector('.text-3xl');
                                    if (desktopInv) desktopInv.innerText = gameState.factoryInventory;
                                    if (mobileInv) mobileInv.innerText = gameState.factoryInventory;

                                    // Week slots (desktop)
                                    if (els.orangeWeek1) els.orangeWeek1.innerText = gameState.orangeWeek1;
                                    if (els.orangeWeek2) els.orangeWeek2.innerText = gameState.orangeWeek2;
                                    if (els.violetWeek1) els.violetWeek1.innerText = gameState.violetWeek1;
                                    if (els.violetWeek2) els.violetWeek2.innerText = gameState.violetWeek2;

                                    // Week slots (mobile)
                                    if (els.mobileDeliveryWeek1) els.mobileDeliveryWeek1.innerText = gameState.orangeWeek1;
                                    if (els.mobileDeliveryWeek2) els.mobileDeliveryWeek2.innerText = gameState.orangeWeek2;
                                    if (els.mobileOutgoingWeek1) els.mobileOutgoingWeek1.innerText = gameState.violetWeek1;
                                    if (els.mobileOutgoingWeek2) els.mobileOutgoingWeek2.innerText = gameState.violetWeek2;
                                }

                                // Initialize DOM from gameState on page load
                                syncStateToDOM();

                                // --- Mobile Detection ---
                                const isMobile = () => window.innerWidth < 1024;

                                // --- Get current order input based on screen size ---
                                const getCurrentOrderInput = () => isMobile() ? mobileOrderInput : orderInput;
                                const getCurrentBtnSend = () => isMobile() ? mobileBtnSend : btnSend;

                                // --- Input Logic ---
                                const validateInput = () => {
                                    const currentInput = getCurrentOrderInput();
                                    const currentBtn = getCurrentBtnSend();
                                    const val = currentInput?.value;
                                    const isEmpty = val === '' || val === null;

                                    if (currentBtn) {
                                        if (isEmpty) {
                                            currentBtn.disabled = true;
                                            currentBtn.classList.add('opacity-50', 'cursor-not-allowed');
                                            currentBtn.classList.remove('hover:bg-accent/10');
                                        } else {
                                            currentBtn.disabled = false;
                                            currentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                            currentBtn.classList.add('hover:bg-accent/10');
                                        }
                                    }
                                };

                                // Desktop input handlers
                                if (btnUp) btnUp.addEventListener('click', () => { orderInput.stepUp(); validateInput(); });
                                if (btnDown) btnDown.addEventListener('click', () => { orderInput.stepDown(); validateInput(); });
                                if (orderInput) {
                                    orderInput.addEventListener('input', validateInput);
                                    orderInput.addEventListener('change', () => {
                                        if (orderInput.value < 0) orderInput.value = 0;
                                        validateInput();
                                    });
                                }

                                // Mobile input handlers
                                if (mobileBtnUp) mobileBtnUp.addEventListener('click', () => { mobileOrderInput.stepUp(); validateInput(); });
                                if (mobileBtnDown) mobileBtnDown.addEventListener('click', () => { mobileOrderInput.stepDown(); validateInput(); });
                                if (mobileOrderInput) {
                                    mobileOrderInput.addEventListener('input', validateInput);
                                    mobileOrderInput.addEventListener('change', () => {
                                        if (mobileOrderInput.value < 0) mobileOrderInput.value = 0;
                                        validateInput();
                                    });
                                }

                                validateInput();

                                // --- Animation Logic ---

                                // Helper to clone and animate (defined outside so both mobile and desktop can use it)
                                    const animateClone = (sourceEl, targetEl, textOverride = null, pathType = 'direct', onComplete = null, persist = false, overwrite = false) => {
                                        if (!sourceEl || !targetEl) {
                                            console.error("Animation Source or Target missing", { sourceEl, targetEl });
                                            return;
                                        }

                                        const rectSource = sourceEl.getBoundingClientRect();
                                        const rectTarget = targetEl.getBoundingClientRect();

                                        // Create Ghost
                                        const clone = sourceEl.cloneNode(true);

                                        // Clean up clone IDs/inputs
                                        clone.id = '';
                                        const input = clone.querySelector('input');
                                        if (input) {
                                            const val = input.value;
                                            const span = document.createElement('span');
                                            span.innerText = val;
                                            span.className = input.className.replace('bg-transparent', '');
                                            span.style.display = 'inline-block';
                                            input.replaceWith(span);
                                            const btns = clone.querySelectorAll('button');
                                            btns.forEach(b => b.remove());
                                        }

                                        if (textOverride !== null) {
                                            const numberDiv = clone.querySelector('.font-bold') || clone;
                                            if (numberDiv) numberDiv.innerText = textOverride;
                                            else clone.innerText = textOverride;
                                        }

                                        // Style Ghost
                                        clone.style.position = 'fixed';
                                        clone.style.left = `${rectSource.left}px`;
                                        clone.style.top = `${rectSource.top}px`;
                                        clone.style.width = `${rectSource.width}px`;
                                        clone.style.height = `${rectSource.height}px`;
                                        clone.style.margin = '0';
                                        clone.style.zIndex = '9999';
                                        clone.style.pointerEvents = 'none';
                                        clone.style.transition = 'none';
                                        document.body.appendChild(clone);

                                        // Calculate Keyframes
                                        let keyframes;
                                        const deltaX = rectTarget.left - rectSource.left;
                                        const deltaY = rectTarget.top - rectSource.top;

                                        if (pathType === 'dogleg') {
                                            // Horizontal to left border, then down to center
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;

                                            const waypointX = deltaX; // Align left edges
                                            const finalX = deltaX + centerOffsetX; // Center in box
                                            const finalY = deltaY + centerOffsetY; // Center in box

                                            keyframes = [
                                                { transform: 'translate(0, 0)', offset: 0 },
                                                { transform: `translate(${waypointX}px, 0)`, offset: 0.6 },
                                                { transform: `translate(${finalX}px, ${finalY}px)`, offset: 1 }
                                            ];
                                        } else if (pathType === 'vertical-dogleg') {
                                            // Vertical first, then horizontal
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;

                                            const finalX = deltaX + centerOffsetX;
                                            const finalY = deltaY + centerOffsetY;
                                            // Move vertically to target's Y level (plus centering)
                                            const adjustedY = finalY;

                                            keyframes = [
                                                { transform: 'translate(0, 0)', offset: 0 },
                                                { transform: `translate(0, ${adjustedY}px)`, offset: 0.6 },
                                                { transform: `translate(${finalX}px, ${adjustedY}px)`, offset: 1 }
                                            ];
                                        } else if (pathType === 'vertical-align-y') {
                                            // Vertical only, align to target's Y center, preserve Source X
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                                            const finalY = deltaY + centerOffsetY;

                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(0, ${finalY}px)` }
                                            ];
                                        } else if (pathType === 'horizontal') {
                                            // Horizontal only, keep Y at 0, center at target
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const finalX = deltaX + centerOffsetX;
                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(${finalX}px, 0)` }
                                            ];
                                        } else if (pathType === 'vertical-down' || pathType === 'vertical-up') {
                                            // Vertical movement with centering
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                                            const finalX = deltaX + centerOffsetX;
                                            const finalY = deltaY + centerOffsetY;
                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(${finalX}px, ${finalY}px)` }
                                            ];
                                        } else {
                                            // Direct path
                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(${deltaX}px, ${deltaY}px)` }
                                            ];
                                        }

                                        // Animate
                                        const animation = clone.animate(keyframes, {
                                            duration: 2000,
                                            easing: 'ease-in-out',
                                            fill: 'forwards'
                                        });

                                        animation.onfinish = () => {
                                            if (!persist) clone.remove();
                                            // Optional: update target text
                                            if (overwrite || targetEl.innerText.trim() === '' || targetEl.innerText.trim() === '&nbsp;') {
                                                targetEl.innerText = input ? input.value : clone.innerText.trim();
                                            }
                                            if (onComplete) onComplete(clone);
                                        };
                                    };

                                    // --- Mobile Animation Function ---
                                const startMobileAnimation = () => {
                                    console.log("Starting Mobile Animations (Vertical)...");

                                    const orderVal = mobileOrderInput?.value || '0';
                                    const randomIncomingOrder = gameState.generateIncomingOrder();

                                    // Get current values from gameState
                                    const deliveryWeek1Val = gameState.orangeWeek1.toString();
                                    const deliveryWeek2Val = gameState.orangeWeek2.toString();
                                    const outgoingWeek1Val = gameState.violetWeek1.toString();
                                    const outgoingWeek2Val = gameState.violetWeek2.toString();

                                    // ========================================
                                    // PHASE 1: Two parallel animations (both DOWNWARD)
                                    // 1. Distributor Order -> Factory Order Received
                                    // 2. Factory Order -> Production Order
                                    // Only inner value boxes animate, NOT containers with labels
                                    // ========================================

                                    // --- Animation 1: Distributor Order -> Factory Order Received ---
                                    // Animate ONLY the inner value box (mobileDistributorOrder) to factory order inner box
                                    // Direction: vertical-down (distributor is at top, factory is below)
                                    if (mobileDistributorOrder && mobileFactoryOrder) {
                                        animateClone(mobileDistributorOrder, mobileFactoryOrder, randomIncomingOrder.toString(), 'vertical-down', () => {
                                            // Update factory order received slot - value stays visible here
                                            mobileFactoryOrder.innerText = randomIncomingOrder;
                                            if (els.factoryOrderReceivedInner) els.factoryOrderReceivedInner.innerText = randomIncomingOrder;
                                            console.log("Phase 1a complete: Order arrived at factory order slot");
                                        }, false, true);
                                    }

                                    // --- Animation 2: Factory Order -> Production Order ---
                                    // Get the factory order value box (the div containing the input's parent)
                                    const mobileOrderValueBox = mobileOrderInput?.parentElement;

                                    if (mobileOrderValueBox && mobileProductionOrder) {
                                        // Animate the order value box downward to production order slot
                                        // Direction: vertical-down (factory is above production in mobile layout)
                                        animateClone(mobileOrderValueBox, mobileProductionOrder, orderVal, 'vertical-down', () => {
                                            // Update production order slot - value stays visible here
                                            mobileProductionOrder.innerText = orderVal;
                                            if (els.productionOrderInner) els.productionOrderInner.innerText = orderVal;
                                            console.log("Phase 1b complete: Order arrived at production order slot");

                                            // Clear the factory order input after animation
                                            if (mobileOrderInput) mobileOrderInput.value = '';
                                        }, false, true);
                                    }

                                    // --- Animation 3: Outgoing Week 2 inner -> Distributor (UP along pipe, then RIGHT into distributor inventory) ---
                                    const distributorInventoryEl = document.getElementById('distributor-inventory');

                                    if (els.mobileOutgoingWeek2 && mobileDistributorOrder && distributorInventoryEl) {
                                        // Calculate distances
                                        const week2Rect = els.mobileOutgoingWeek2.getBoundingClientRect();
                                        const orderRect = mobileDistributorOrder.getBoundingClientRect();
                                        const distributorInventoryRect = distributorInventoryEl.getBoundingClientRect();
                                        const verticalDistance = week2Rect.top - orderRect.top;
                                        const horizontalDistance = distributorInventoryRect.left + (distributorInventoryRect.width / 2) - week2Rect.left - (week2Rect.width / 2);

                                        // Clone the element
                                        const clone = els.mobileOutgoingWeek2.cloneNode(true);
                                        clone.id = '';
                                        clone.innerText = outgoingWeek2Val;
                                        clone.style.position = 'fixed';
                                        clone.style.left = `${week2Rect.left}px`;
                                        clone.style.top = `${week2Rect.top}px`;
                                        clone.style.width = `${week2Rect.width}px`;
                                        clone.style.height = `${week2Rect.height}px`;
                                        clone.style.margin = '0';
                                        clone.style.zIndex = '9999';
                                        clone.style.pointerEvents = 'none';
                                        document.body.appendChild(clone);

                                        // Single smooth animation: UP then RIGHT, with fade at end
                                        // Note: on mobile with flex-col-reverse, 'Top' is visual Top (Distributor). 
                                        // Week2 is below it. So week2.top > distributor.top. distance is negative. 
                                        // translate(0, -dist) moves up.
                                        // We calculate offsets manually here.
                                        
                                        // Animation path: Move vertically to Distributor level, then horizontally to center
                                        const animKeys = [
                                            { transform: 'translate(0, 0)', opacity: 1 },
                                            { transform: `translate(0, -${verticalDistance}px)`, opacity: 1, offset: 0.5 },
                                            { transform: `translate(${horizontalDistance}px, -${verticalDistance}px)`, opacity: 0 }
                                        ];

                                        const animation = clone.animate(animKeys, {
                                            duration: 2000,
                                            easing: 'linear',
                                            fill: 'forwards'
                                        });

                                        animation.onfinish = () => {
                                            clone.remove();
                                            console.log("Phase 1c complete: Week 2 delivered to distributor");
                                        };

                                        // Clear Week 2 slot
                                        els.mobileOutgoingWeek2.style.opacity = '0';
                                    }

                                    // --- Animation 4: Outgoing Week 1 inner -> Week 2 slot (UP) ---
                                    if (els.mobileOutgoingWeek1 && els.mobileOutgoingWeek2) {
                                        animateClone(els.mobileOutgoingWeek1, els.mobileOutgoingWeek2, outgoingWeek1Val, 'vertical-up', () => {
                                            // Update gameState and sync
                                            gameState.violetWeek2 = parseInt(outgoingWeek1Val);
                                            els.mobileOutgoingWeek2.innerText = outgoingWeek1Val;
                                            els.mobileOutgoingWeek2.style.opacity = '1';
                                            syncStateToDOM();
                                            console.log("Phase 1d complete: Week 1 moved to Week 2 slot");
                                        }, false, true);

                                        // Clear Week 1 slot
                                        els.mobileOutgoingWeek1.style.opacity = '0';
                                    }

                                    // --- Animation 5: Production Week 2 -> Factory Inventory ---
                                    // Path: LEFT to pipe center, UP along pipe, RIGHT to inventory VALUE
                                    const factoryInventoryMobile = document.getElementById('factory-inventory-mobile');
                                    const productionWeek2Val = gameState.productionWeek2.toString();

                                    if (els.mobileProductionWeek2 && factoryInventoryMobile) {
                                        // Get positions
                                        const week2Rect = els.mobileProductionWeek2.getBoundingClientRect();

                                        // Get the inventory VALUE element (the number inside the inventory box)
                                        const inventoryValueEl = factoryInventoryMobile.querySelector('.text-3xl');
                                        const inventoryValueRect = inventoryValueEl ? inventoryValueEl.getBoundingClientRect() : factoryInventoryMobile.getBoundingClientRect();

                                        // Find the left pipe element directly
                                        const pipeConnector = document.querySelector('.flex.lg\\:hidden.flex-row.items-stretch.justify-between.w-full.px-\\[calc\\(25\\%-60px\\)\\].min-h-\\[200px\\]');
                                        let pipeCenterX;
                                        if (pipeConnector) {
                                            const leftPipe = pipeConnector.firstElementChild;
                                            if (leftPipe) {
                                                const pipeRect = leftPipe.getBoundingClientRect();
                                                pipeCenterX = pipeRect.left + pipeRect.width / 2;
                                            }
                                        }
                                        // Fallback if pipe not found
                                        if (!pipeCenterX) {
                                            pipeCenterX = week2Rect.left - 30;
                                        }

                                        // Step 1: Move LEFT to pipe center
                                        const deltaX1 = pipeCenterX - (week2Rect.left + week2Rect.width/2);

                                        // Step 2: Move UP to inventory value level
                                        const deltaY = inventoryValueRect.top + (inventoryValueRect.height/2) - (week2Rect.top + week2Rect.height/2);

                                        // Step 3: Move RIGHT to align with inventory value
                                        const deltaX2 = inventoryValueRect.left + (inventoryValueRect.width/2) - pipeCenterX;

                                        // Clone the element
                                        const clone = els.mobileProductionWeek2.cloneNode(true);
                                        clone.id = '';
                                        clone.innerText = productionWeek2Val;
                                        clone.style.position = 'fixed';
                                        clone.style.left = `${week2Rect.left}px`;
                                        clone.style.top = `${week2Rect.top}px`;
                                        clone.style.width = `${week2Rect.width}px`;
                                        clone.style.height = `${week2Rect.height}px`;
                                        clone.style.margin = '0';
                                        clone.style.zIndex = '9999';
                                        clone.style.pointerEvents = 'none';
                                        document.body.appendChild(clone);

                                        // Three-step animation: LEFT to pipe, UP along pipe, RIGHT to inventory value
                                        const animation = clone.animate([
                                            { transform: 'translate(0, 0)', opacity: 1 },
                                            { transform: `translate(${deltaX1}px, 0)`, opacity: 1, offset: 0.25 },
                                            { transform: `translate(${deltaX1}px, ${deltaY}px)`, opacity: 1, offset: 0.75 },
                                            { transform: `translate(${deltaX1 + deltaX2}px, ${deltaY}px)`, opacity: 0 }
                                        ], {
                                            duration: 2000,
                                            easing: 'linear',
                                            fill: 'forwards'
                                        });

                                        animation.onfinish = () => {
                                            clone.remove();
                                            // Update inventory value using gameState
                                            gameState.receiveDelivery(parseInt(productionWeek2Val || 0));
                                            syncStateToDOM();
                                            console.log("Phase 1e complete: Production Week 2 delivered to inventory");
                                        };

                                        // Clear Week 2 slot
                                        els.mobileProductionWeek2.style.opacity = '0';
                                    }

                                    // --- Animation 6: Production Week 1 -> Production Week 2 slot ---
                                    const productionWeek1Val = gameState.productionWeek1.toString();

                                    if (els.mobileProductionWeek1 && els.mobileProductionWeek2) {
                                        const week1Rect = els.mobileProductionWeek1.getBoundingClientRect();
                                        const week2Rect = els.mobileProductionWeek2.getBoundingClientRect();

                                        // Horizontal movement from Week 1 to Week 2 (LEFT)
                                        const deltaX = week2Rect.left + (week2Rect.width/2) - (week1Rect.left + week1Rect.width/2);

                                        // Clone the element
                                        const clone = els.mobileProductionWeek1.cloneNode(true);
                                        clone.id = '';
                                        clone.innerText = productionWeek1Val;
                                        clone.style.position = 'fixed';
                                        clone.style.left = `${week1Rect.left}px`;
                                        clone.style.top = `${week1Rect.top}px`;
                                        clone.style.width = `${week1Rect.width}px`;
                                        clone.style.height = `${week1Rect.height}px`;
                                        clone.style.margin = '0';
                                        clone.style.zIndex = '9999';
                                        clone.style.pointerEvents = 'none';
                                        document.body.appendChild(clone);

                                        // Simple horizontal animation from Week 1 to Week 2
                                        const animation = clone.animate([
                                            { transform: 'translate(0, 0)', opacity: 1 },
                                            { transform: `translate(${deltaX}px, 0)`, opacity: 1 }
                                        ], {
                                            duration: 2000,
                                            easing: 'linear',
                                            fill: 'forwards'
                                        });

                                        animation.onfinish = () => {
                                            clone.remove();
                                            // Update Week 2 with Week 1's value
                                            gameState.productionWeek2 = parseInt(productionWeek1Val);
                                            els.mobileProductionWeek2.innerText = productionWeek1Val;
                                            els.mobileProductionWeek2.style.opacity = '1';
                                            syncStateToDOM();
                                            console.log("Phase 1f complete: Production Week 1 moved to Week 2 slot");
                                        };

                                        // Clear Week 1 slot
                                        els.mobileProductionWeek1.style.opacity = '0';
                                    }

                                    // ========================================
                                    // PHASE 2: After 1 sec pause
                                    // 1. Order in Factory -> LEFT into Inventory -> Morph to cyan (production)
                                    // 2. Order in Factory (Received) -> LEFT to center, DOWN into Inventory -> Morph to orange (outgoing)
                                    // ========================================
                                    setTimeout(() => {
                                        console.log("Starting Phase 2...");

                                        const factoryInventoryMobileEl = document.getElementById('factory-inventory-mobile');

                                        // --- Phase 2: Factory Order Received (from Distributor) -> Inventory ---
                                        // Note: Incoming is Violet. Becomes Outgoing Delivery (Orange/Accent).
                                        if (mobileFactoryOrder && factoryInventoryMobileEl) {
                                            // Wait, mobileFactoryOrder is the Output slot.
                                            // We want the INPUT slot: mobileDistributorOrder (which visually moved to factory input)
                                            // But in Phase 1a, we updated mobileFactoryOrder with the value.
                                            // So we start from mobileFactoryOrder (which now holds the incoming value).
                                            
                                            const orderRect = mobileFactoryOrder.getBoundingClientRect();
                                            const invRect = factoryInventoryMobileEl.getBoundingClientRect();

                                            const horizDist = invRect.left + (invRect.width / 2) - orderRect.left - (orderRect.width / 2);
                                            const targetY = invRect.top + (invRect.height * 0.40);
                                            const vertDist = targetY - orderRect.top - (orderRect.height / 2);

                                            const orderValue = gameState.incomingOrder;
                                            const { outgoing: outgoingDelivery, newInventory: newFactoryInv } = gameState.processFactoryOrder(orderValue);

                                            const orderClone = mobileFactoryOrder.cloneNode(true);
                                            orderClone.id = '';
                                            orderClone.innerText = orderValue;
                                            orderClone.style.position = 'fixed';
                                            orderClone.style.left = `${orderRect.left}px`;
                                            orderClone.style.top = `${orderRect.top}px`;
                                            orderClone.style.width = `${orderRect.width}px`;
                                            orderClone.style.height = `${orderRect.height}px`;
                                            orderClone.style.margin = '0';
                                            orderClone.style.zIndex = '9999';
                                            orderClone.style.pointerEvents = 'none';
                                            document.body.appendChild(orderClone);

                                            mobileFactoryOrder.innerText = orderValue;

                                            const orderAnimation = orderClone.animate([
                                                { transform: 'translate(0, 0)', opacity: 1 },
                                                { transform: `translate(${horizDist}px, 0)`, opacity: 1, offset: 0.5 },
                                                { transform: `translate(${horizDist}px, ${vertDist}px)`, opacity: 1 }
                                            ], {
                                                duration: 2000,
                                                easing: 'linear',
                                                fill: 'forwards'
                                            });

                                            orderAnimation.onfinish = () => {
                                                // Morph to Orange/Accent (outgoing delivery)
                                                orderClone.style.transition = 'all 0.5s ease-in-out';
                                                orderClone.style.backgroundColor = 'rgba(249, 115, 22, 0.1)'; // accent/10
                                                orderClone.style.borderColor = 'rgba(249, 115, 22, 0.2)';
                                                orderClone.style.color = 'rgb(251, 146, 60)'; // orange-400
                                                orderClone.innerText = outgoingDelivery;

                                                syncStateToDOM();

                                                setTimeout(() => {
                                                    const cloneRect = orderClone.getBoundingClientRect();
                                                    const invRect2 = factoryInventoryMobileEl.getBoundingClientRect();
                                                    const relLeft = cloneRect.left - invRect2.left;
                                                    const relTop = cloneRect.top - invRect2.top;

                                                    const orangeSlot = document.createElement('div');
                                                    orangeSlot.className = 'bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px] absolute';
                                                    orangeSlot.innerText = outgoingDelivery;
                                                    orangeSlot.style.left = `${relLeft}px`;
                                                    orangeSlot.style.top = `${relTop}px`;
                                                    orangeSlot.style.width = `${cloneRect.width}px`;
                                                    orangeSlot.style.zIndex = '50';

                                                    orderClone.remove();
                                                    factoryInventoryMobileEl.appendChild(orangeSlot);

                                                    console.log(`Phase 2b complete: Order morphed to outgoing delivery (${outgoingDelivery})`);
                                                    gameState.phase2.outgoingClone = orangeSlot;
                                                }, 500);
                                            };
                                        }
                                    }, 3000); 

                                    // --- Phase 3: Outgoing delivery moves to Week 1 slot ---
                                    setTimeout(() => {
                                        console.log("Starting Phase 3...");

                                        // Orange outgoing slot -> Distributor Week 1 (RIGHT then UP)
                                        // Factory (Middle) -> Distributor (Top).
                                        // Week 1 is Above.
                                        // Flow: Inventory (Middle) -> Week 1 (Above). Direction: UP.
                                        const orangeSlot = gameState.phase2.outgoingClone;
                                        const outgoingWeek1Target = els.mobileOutgoingWeek1;

                                        if (orangeSlot && outgoingWeek1Target) {
                                            const orangeRect = orangeSlot.getBoundingClientRect();
                                            const outWeek1Rect = outgoingWeek1Target.getBoundingClientRect();

                                            const pipeCenterX = outWeek1Rect.left + (outWeek1Rect.width / 2);
                                            const horizDistG = pipeCenterX - orangeRect.left - (orangeRect.width / 2);
                                            const vertDistG = outWeek1Rect.top - orangeRect.top; // Negative (Up)

                                            const animCloneG = document.createElement('div');
                                            animCloneG.className = 'lg:hidden bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]';
                                            animCloneG.innerText = orangeSlot.innerText;
                                            animCloneG.style.position = 'fixed';
                                            animCloneG.style.left = `${orangeRect.left}px`;
                                            animCloneG.style.top = `${orangeRect.top}px`;
                                            animCloneG.style.width = `${orangeRect.width}px`;
                                            animCloneG.style.height = `${orangeRect.height}px`;
                                            animCloneG.style.zIndex = '9999';
                                            animCloneG.style.pointerEvents = 'none';
                                            document.body.appendChild(animCloneG);

                                            orangeSlot.style.opacity = '0';

                                            const animationG = animCloneG.animate([
                                                { transform: 'translate(0, 0)', opacity: 1 },
                                                { transform: `translate(${horizDistG}px, 0)`, opacity: 1, offset: 0.4 },
                                                { transform: `translate(${horizDistG}px, ${vertDistG}px)`, opacity: 1 }
                                            ], {
                                                duration: 2000,
                                                easing: 'linear',
                                                fill: 'forwards'
                                            });

                                            animationG.onfinish = () => {
                                                animCloneG.remove();
                                                gameState.violetWeek1 = gameState.factoryOutgoing; // Orange
                                                outgoingWeek1Target.innerText = gameState.violetWeek1;
                                                outgoingWeek1Target.style.opacity = '1';
                                                orangeSlot.remove();
                                                syncStateToDOM();
                                                console.log("Phase 3b complete: Orange outgoing moved to Week 1 slot");
                                            };
                                        }
                                    }, 8000); // Wait for Phase 1 (2s) + pause (1s) + Phase 2 (2s) + morph (0.5s) + buffer

                                    setTimeout(() => {
                                        if (mobileOrderInput) mobileOrderInput.disabled = false;
                                        if (mobileBtnUp) mobileBtnUp.disabled = false;
                                        if (mobileBtnDown) mobileBtnDown.disabled = false;
                                        if (mobileBtnSend) {
                                            mobileBtnSend.querySelector('span').innerText = "Send";
                                            mobileBtnSend.disabled = false;
                                            mobileBtnSend.classList.remove('opacity-50', 'cursor-not-allowed');
                                            validateInput();
                                        }
                                    }, 11000); // Phase 3 (8s) + animation (2s) + buffer
                                };

                                // --- Desktop Animation Function ---
                                const startDesktopAnimation = () => {
                                    console.log("Starting Desktop Animations (Horizontal)...");

                                    // 1. Factory Order -> Production Order (Direct)
                                    // Factory (Center) -> Production (Left). DeltaX negative.
                                    if (els.factoryOrderInner && els.productionOrderInner) {
                                        animateClone(els.factoryOrderInner, els.productionOrderInner, null, 'direct', () => {
                                            // PHASE 2: Production Order -> Middle of Inventory (Vertical Align Y)
                                            setTimeout(() => {
                                                if (els.productionOrderInner && els.productionInventory) {
                                                    animateClone(els.productionOrderInner, els.productionInventory, null, 'vertical-align-y', (persistedClone) => {
                                                        // PHASE 3: Morph & Move to Week 1
                                                        setTimeout(() => {
                                                            if (!persistedClone) return;

                                                            // Morph into Cyan (Production) Delivery
                                                            persistedClone.classList.remove('bg-accent/10', 'border-accent/20', 'text-accent');
                                                            persistedClone.classList.add('bg-production/10', 'border-production/20', 'text-production');

                                                            const valSpan = persistedClone.querySelector('span') || persistedClone.querySelector('.font-bold') || persistedClone;
                                                            const orderVal = parseInt(valSpan.innerText) || 0;
                                                            // Use gameState for delivery calculation
                                                            const deliverVal = gameState.processProductionOrder(orderVal);
                                                            valSpan.innerText = deliverVal;

                                                            // Move to OrangeWeek1 (which is actually Production delivery slot)
                                                            if (els.orangeWeek1) {
                                                                animateClone(persistedClone, els.orangeWeek1, deliverVal, 'vertical-dogleg', () => {
                                                                    gameState.orangeWeek1 = deliverVal;
                                                                    els.orangeWeek1.innerText = gameState.orangeWeek1;
                                                                    els.orangeWeek1.style.opacity = '1';
                                                                    syncStateToDOM();
                                                                });
                                                                persistedClone.remove();
                                                            }
                                                        }, 1000);
                                                    }, true);
                                                }
                                            }, 1000);
                                        }, false, true);
                                    }

                                    // Clear source Factory Order
                                    const desktopOrderInput = els.factoryOrderInner?.querySelector('input');
                                    if (desktopOrderInput) desktopOrderInput.value = '';

                                    // 2. Production Delivery (Cyan) Week 2 -> Factory Inventory
                                    if (els.orangeWeek2 && els.factoryInventory) {
                                        animateClone(els.orangeWeek2, els.factoryInventory, null, 'dogleg', () => {
                                            gameState.receiveDelivery(gameState.orangeWeek2);
                                            syncStateToDOM();
                                        });
                                        els.orangeWeek2.style.opacity = '0';
                                    }

                                    // 3. Production Delivery Week 1 -> Week 2
                                    if (els.orangeWeek1 && els.orangeWeek2) {
                                        const val = gameState.orangeWeek1;
                                        animateClone(els.orangeWeek1, els.orangeWeek2, null, 'direct', () => {
                                            gameState.orangeWeek2 = val;
                                            els.orangeWeek2.innerText = gameState.orangeWeek2;
                                            els.orangeWeek2.style.opacity = '1';
                                        });
                                        els.orangeWeek1.style.opacity = '0';
                                    }

                                    // 4. Factory Outgoing (Orange) Week 2 -> Distributor
                                    if (els.violetWeek2 && els.distributorInventory) {
                                        animateClone(els.violetWeek2, els.distributorInventory, null, 'dogleg');
                                        els.violetWeek2.style.opacity = '0';
                                    }

                                    // 5. Factory Outgoing Week 1 -> Week 2
                                    if (els.violetWeek1 && els.violetWeek2) {
                                        const val = gameState.violetWeek1;
                                        animateClone(els.violetWeek1, els.violetWeek2, null, 'direct', () => {
                                            gameState.violetWeek2 = val;
                                            els.violetWeek2.innerText = gameState.violetWeek2;
                                            els.violetWeek2.style.opacity = '1';
                                        });
                                        els.violetWeek1.style.opacity = '0';
                                    }

                                    // 6. Distributor Order (Violet) -> Factory Order Received
                                    if (els.distributorOrder && els.factoryOrderReceived) {
                                        const randomIncomingOrder = gameState.generateIncomingOrder();

                                        animateClone(els.distributorOrder, els.factoryOrderReceived, randomIncomingOrder.toString(), 'horizontal', () => {
                                            const targetNum = els.factoryOrderReceived.querySelector('.font-bold');
                                            if (targetNum) targetNum.innerText = randomIncomingOrder;

                                            setTimeout(() => {
                                                if (els.factoryOrderReceivedInner && els.factoryInventory) {
                                                    animateClone(els.factoryOrderReceivedInner, els.factoryInventory, null, 'vertical-align-y', (persistedClone) => {
                                                        setTimeout(() => {
                                                            if (!persistedClone) return;

                                                            // Morph Violet -> Orange (Accent)
                                                            persistedClone.classList.remove('bg-violet-500/10', 'border-violet-500/20', 'text-violet-400');
                                                            persistedClone.classList.add('bg-accent/10', 'border-accent/20', 'text-accent');

                                                            const valSpan = persistedClone.querySelector('span') || persistedClone.querySelector('.font-bold') || persistedClone;

                                                            const { outgoing: deliverVal, newInventory } = gameState.processFactoryOrder(gameState.incomingOrder);
                                                            valSpan.innerText = deliverVal;

                                                            syncStateToDOM();

                                                            if (els.violetWeek1) {
                                                                animateClone(persistedClone, els.violetWeek1, deliverVal, 'vertical-dogleg', () => {
                                                                    gameState.violetWeek1 = deliverVal;
                                                                    els.violetWeek1.innerText = gameState.violetWeek1;
                                                                    els.violetWeek1.style.opacity = '1';
                                                                    syncStateToDOM();

                                                                    if (orderInput) orderInput.disabled = false;
                                                                    if (btnUp) btnUp.disabled = false;
                                                                    if (btnDown) btnDown.disabled = false;

                                                                    if (btnSend) {
                                                                        btnSend.querySelector('span').innerText = "Send";
                                                                        validateInput();
                                                                    }
                                                                });
                                                                persistedClone.remove();
                                                            }
                                                        }, 1000);
                                                    }, true);
                                                }
                                            }, 1000);
                                        });
                                    }
                                };

                                // --- Main Animation Entry Point ---
                                window.startState3Animation = () => {
                                    console.log("Starting State 3 Animations...");

                                    if (isMobile()) {
                                        startMobileAnimation();
                                    } else {
                                        startDesktopAnimation();
                                    }
                                };

                                // --- Send Button Logic ---
                                // Desktop send button handler
                                if (btnSend) {
                                    btnSend.addEventListener('click', () => {
                                        // State 1 -> Transition
                                        orderInput.disabled = true;
                                        btnUp.disabled = true;
                                        btnDown.disabled = true;
                                        btnSend.disabled = true;

                                        btnSend.querySelector('span').innerText = "WAIT";
                                        btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                                        btnSend.classList.remove('hover:bg-accent/10');

                                        setTimeout(() => {
                                            // State 2: Sent/Waiting
                                            btnSend.querySelector('span').innerText = "SENT";
                                            console.log("Transition to State 2 complete. Order locked.");

                                            // Trigger State 3
                                            startState3Animation();
                                        }, 5000);
                                    });
                                }

                                // Mobile send button handler
                                if (mobileBtnSend) {
                                    mobileBtnSend.addEventListener('click', () => {
                                        // State 1 -> Transition
                                        mobileOrderInput.disabled = true;
                                        mobileBtnUp.disabled = true;
                                        mobileBtnDown.disabled = true;
                                        mobileBtnSend.disabled = true;

                                        mobileBtnSend.querySelector('span').innerText = "WAIT";
                                        mobileBtnSend.classList.add('opacity-50', 'cursor-not-allowed');
                                        mobileBtnSend.classList.remove('hover:bg-accent/10');

                                        // Shorter delay on mobile (no animations)
                                        setTimeout(() => {
                                            // State 2: Sent/Waiting
                                            mobileBtnSend.querySelector('span').innerText = "SENT";
                                            console.log("Mobile: Transition to State 2 complete. Order locked.");

                                            // Trigger State 3
                                            startState3Animation();
                                        }, 500);
                                    });
                                }
                            });
                        </script>

                        <!-- Order Received Box (Right, Dashed) - incoming orders from Distributor - GREEN (Distributor color) -->
                         <div id="factory-order-received" class="bg-mono-surface border border-dashed border-violet-500/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div id="factory-order-received-value" class="bg-violet-500/10 px-3 py-1 rounded border border-violet-500/20 text-violet-400 font-sans font-bold text-center min-w-[55px]">&nbsp;</div>
                        </div>
                    </div>

                    <!-- Mobile: Order Box at bottom - aligned with right pipe -->
                    <div class="lg:hidden p-4 pt-0 bg-mono-surface rounded-b-xl flex justify-end pr-[calc(25%-28px)]">
                        <div class="flex flex-col items-center gap-2 translate-x-1/2">
                            <button class="mobile-btn-send w-full bg-transparent border border-accent hover:bg-accent/10 text-white rounded py-1 shadow-md transition-colors flex items-center justify-center">
                                <span class="text-[10px] font-bold uppercase">Send</span>
                            </button>
                            <div class="bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div class="bg-accent/10 px-3 py-1 rounded border border-accent/20 flex items-center justify-center min-w-[55px]">
                                    <input type="number" value="30" min="0" class="mobile-order-input w-6 bg-transparent text-center font-sans font-bold text-accent border-0 p-0 focus:ring-0 appearance-none" />
                                    <div class="flex flex-col ml-0.5">
                                        <button class="mobile-btn-up text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_up</span></button>
                                        <button class="mobile-btn-down text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_down</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- PIPE SECTION 2: Factory -> Distributor (Hidden on mobile) -->
                <div class="hidden lg:flex flex-1 flex-col justify-between py-4 relative min-w-[200px]">
                     <!-- Top Pipe: Deliveries (Rightward) - VIOLET/ACCENT -->
                     <div class="relative h-16 top-[40px] w-full flex items-center">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 mt-[2px] h-[40px] bg-mono-surface rounded-none"></div>

                        <!-- Delay Boxes (Deliveries to Distributor) - VIOLET/ACCENT -->
                        <div class="absolute w-full flex justify-evenly px-4 z-10 top-0 -mt-[11px]">
                            <!-- Week 1 -->
                             <div class="bg-mono-surface border border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                                <div id="outgoing-week-1" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">25</div>
                            </div>
                            <!-- Week 2 -->
                             <div class="bg-mono-surface border border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                                <div id="outgoing-week-2" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">20</div>
                            </div>
                       </div>
                    </div>

                    <!-- Bottom Pipe: Orders (Leftward) -->
                    <div class="relative h-16 w-full flex items-center top-[5px]">
                         <!-- Pipe Background -->
                         <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[40px] bg-mono-surface rounded-none"></div>
                    </div>
                </div>

                <!-- MOBILE VERTICAL CONNECTOR 2: Factory -> Distributor -->
                <div class="flex lg:hidden flex-row items-stretch justify-between w-full px-[calc(25%-60px)] -my-5">
                    <!-- Left pipe with Week 1/Week 2 boxes (outgoing deliveries flowing down) - VIOLET/ACCENT -->
                    <div class="flex flex-col items-center justify-evenly">
                        <!-- Vertical pipe line (top) - reaches role box -->
                        <div class="w-[70px] h-8 bg-mono-surface"></div>
                        <!-- Week 2 box -->
                        <div id="mobile-outgoing-week-2-box" class="bg-mono-surface border border-accent/30 rounded p-2">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                            <div id="mobile-outgoing-week-2" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">20</div>
                        </div>
                        <!-- Pipe between Week 2 and Week 1 -->
                        <div class="w-[70px] flex-1 min-h-[16px] bg-mono-surface"></div>
                        <!-- Week 1 box -->
                        <div id="mobile-outgoing-week-1-box" class="bg-mono-surface border border-accent/30 rounded p-2">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                            <div id="mobile-outgoing-week-1" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">25</div>
                        </div>
                        <!-- Vertical pipe line (bottom) - reaches role box -->
                        <div class="w-[70px] h-8 bg-mono-surface"></div>
                    </div>
                    <!-- Right pipe - continuous (orders flowing up) -->
                    <div id="mobile-order-pipe" class="w-[70px] self-stretch bg-mono-surface"></div>
                </div>

                <!-- 3. RIGHT NODE: DISTRIBUTOR -->
                <div class="w-full lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-20">
                    <!-- Header - hidden on mobile -->
                    <div class="hidden lg:block p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-sm uppercase tracking-widest font-bold text-center">Distributor</h3>
                    </div>

                    <!-- Mobile: Title (centered) in top row -->
                    <div class="lg:hidden p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Distributor</h3>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center p-3 lg:p-4 space-y-2 relative">
                        <!-- Mobile Order Box - aligned with right pipe, centered with inventory - GREEN (Distributor color) -->
                        <div class="lg:hidden absolute top-1/2 -translate-y-1/2 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-violet-500/30 p-2 rounded shadow-lg z-10">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div class="mobile-distributor-order bg-violet-500/10 px-3 py-1 rounded border border-violet-500/20 text-violet-400 font-sans font-bold text-center min-w-[55px]">?</div>
                        </div>
                        <!-- Hidden Inventory Box (Distributor - downstream) -->
                        <div id="distributor-inventory" class="bg-mono-bg/30 p-4 rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] lg:min-w-[120px] min-h-[80px] lg:min-h-[100px] cursor-help" title="Hidden Information">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-3xl lg:text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">&nbsp;</div>
                        </div>
                    </div>
                    <!-- Order Box (Bottom) - tablet/desktop only - GREEN (Distributor color) -->
                    <div class="hidden lg:flex p-4 bg-mono-surface rounded-b-xl justify-start">
                        <div class="bg-mono-surface border border-violet-500/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div id="distributor-order" class="bg-violet-500/10 px-3 py-1 rounded border border-violet-500/20 text-violet-400 font-sans font-bold text-center min-w-[55px]">?</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Animation Styles -->
            <style>
                @keyframes slideRight {
                    0% { transform: translateX(-100%); opacity: 0; }
                    50% { opacity: 1; }
                    100% { transform: translateX(100%); opacity: 0; }
                }
                @keyframes slideLeft {
                    0% { transform: translateX(100%); opacity: 0; }
                    50% { opacity: 1; }
                    100% { transform: translateX(-100%); opacity: 0; }
                }
                @keyframes extendLeft {
                    0% { width: 0; opacity: 0.5; }
                    100% { width: 100%; opacity: 0; }
                }
            </style>

            <!-- Charts Container -->
            <div id="charts-root" class="w-full flex-1 min-h-[320px] mt-8 mb-8"></div>
        </div>
    </div>

    <script type="text/babel">
        const { LineChart, Line, BarChart, Bar, ComposedChart, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } = Recharts;

        // Statistics Calculator Utility
        const StatisticsCalculator = {
            calculate(values) {
                if (!values || values.length === 0) return this.getEmptyStats();

                const n = values.length;
                const sorted = [...values].sort((a, b) => a - b);

                // Central tendency
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / n;
                const median = this.calculateMedian(sorted);
                const mode = this.calculateMode(values);

                // Dispersion
                const min = sorted[0];
                const max = sorted[n - 1];
                const range = max - min;
                const variance = n > 1 ? values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / (n - 1) : 0;
                const stdDev = Math.sqrt(variance);

                // Distribution shape
                const coeffVar = mean !== 0 ? (stdDev / Math.abs(mean)) * 100 : null;
                const skewness = this.calculateSkewness(values, mean, stdDev, n);
                const kurtosis = this.calculateKurtosis(values, mean, stdDev, n);
                const iqr = this.calculateIQR(sorted);

                // Inference (95% CI using CLT)
                const sem = n > 0 ? stdDev / Math.sqrt(n) : 0;
                const tCritical = this.getTCritical(n - 1);
                const marginError = tCritical * sem;
                const ci95Lower = mean - marginError;
                const ci95Upper = mean + marginError;

                return { n, min, max, mean, stdDev, coeffVar, mode, median, range, iqr, skewness, kurtosis, sem, marginError, ci95Lower, ci95Upper };
            },

            calculateMedian(sorted) {
                const n = sorted.length;
                const mid = Math.floor(n / 2);
                return n % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            },

            calculateMode(values) {
                const freq = {};
                values.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const maxFreq = Math.max(...Object.values(freq));
                if (maxFreq === 1) return 'None';
                const modes = Object.keys(freq).filter(k => freq[k] === maxFreq).map(Number);
                return modes.length === values.length ? 'None' : modes.join(', ');
            },

            calculateSkewness(values, mean, stdDev, n) {
                if (stdDev === 0 || n < 3) return null;
                const m3 = values.reduce((s, v) => s + Math.pow(v - mean, 3), 0) / n;
                const m2 = values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / n;
                return (m3 / Math.pow(m2, 1.5)) * Math.sqrt(n * (n - 1)) / (n - 2);
            },

            calculateKurtosis(values, mean, stdDev, n) {
                if (stdDev === 0 || n < 4) return null;
                const m4 = values.reduce((s, v) => s + Math.pow(v - mean, 4), 0) / n;
                const m2 = values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / n;
                const g2 = (m4 / Math.pow(m2, 2)) - 3;
                return ((n + 1) * g2 + 6) * (n - 1) / ((n - 2) * (n - 3));
            },

            calculateIQR(sorted) {
                const n = sorted.length;
                const q1 = sorted[Math.floor(n * 0.25)];
                const q3 = sorted[Math.floor(n * 0.75)];
                return q3 - q1;
            },

            getTCritical(df) {
                const tTable = {1:12.706,2:4.303,3:3.182,4:2.776,5:2.571,6:2.447,7:2.365,8:2.306,9:2.262,10:2.228,
                                11:2.201,12:2.179,13:2.160,14:2.145,15:2.131,20:2.086,25:2.060,29:2.045};
                if (df >= 30) return 1.96;
                return tTable[df] || tTable[Math.max(...Object.keys(tTable).map(Number).filter(k => k <= df))] || 2.0;
            },

            getEmptyStats() {
                return { n:0, min:'-', max:'-', mean:'-', stdDev:'-', coeffVar:'-', mode:'-', median:'-',
                         range:'-', iqr:'-', skewness:'-', kurtosis:'-', sem:'-', marginError:'-', ci95Lower:'-', ci95Upper:'-' };
            }
        };

        // Cost rates
        const HOLDING_COST_RATE = 10;   // $ per unit of inventory per week
        const BACKORDER_COST_RATE = 20; // $ per unit of backorder per week

        // Initial conditions
        const INITIAL_INVENTORY = 50;

        // External inputs: orders (from distributor) and deliveries (from production)
        const weeklyInputs = [
            { week: '1', orders: 10, deliveries: 0 },
            { week: '2', orders: 12, deliveries: 10 },
            { week: '3', orders: 15, deliveries: 10 },
            { week: '4', orders: 25, deliveries: 12 },
            { week: '5', orders: 40, deliveries: 15 },
            { week: '6', orders: 35, deliveries: 20 },
            { week: '7', orders: 30, deliveries: 25 },
            { week: '8', orders: 20, deliveries: 30 },
            { week: '9', orders: 15, deliveries: 25 },
            { week: '10', orders: 12, deliveries: 20 },
        ];

        // Simulate the game: compute inventory, backorders, outgoing orders
        let inventory = INITIAL_INVENTORY;
        let backorders = 0;
        let cumHolding = 0;
        let cumBackorder = 0;

        const data = weeklyInputs.map(input => {
            // Available stock = current inventory + incoming deliveries
            const available = inventory + input.deliveries;

            // Total orders = new orders + any backorders from previous weeks
            const totalOrders = input.orders + backorders;

            // Outgoing deliveries (what we actually ship) = min(available, totalOrders)
            const outgoingDeliveries = Math.min(available, totalOrders);

            // New inventory = max(0, available - totalOrders)
            const newInventory = Math.max(0, available - totalOrders);

            // New backorders = max(0, totalOrders - available)
            const newBackorders = Math.max(0, totalOrders - available);

            // Costs based on END-of-period inventory/backorders
            const holdingCost = newInventory * HOLDING_COST_RATE;
            const backorderCost = newBackorders * BACKORDER_COST_RATE;
            cumHolding += holdingCost;
            cumBackorder += backorderCost;

            const row = {
                week: input.week,
                incomingOrders: input.orders,         // Orders from distributor
                deliveries: input.deliveries,         // Deliveries from production
                outgoingOrders: outgoingDeliveries,   // What we ship = min(available, orders)
                inventory: newInventory,              // End-of-period inventory
                backorders: newBackorders,            // End-of-period backorders
                holdingCost,
                backorderCost,
                cumHoldingCost: cumHolding,
                cumBackorderCost: cumBackorder,
                totalCost: cumHolding + cumBackorder
            };

            // Update state for next week
            inventory = newInventory;
            backorders = newBackorders;

            return row;
        });

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-mono-surface border border-mono-light/20 p-3 rounded shadow-xl">
                        <p className="text-mono-text font-bold mb-1">{label}</p>
                        {payload.map((entry, index) => (
                            <p key={index} style={{ color: entry.color }} className="text-sm">
                                {entry.name}: {entry.value}
                            </p>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // StatItem - individual stat display
        const StatItem = ({ label, value }) => (
            <div className="flex justify-between items-center">
                <span className="text-xs text-mono-light">{label}</span>
                <span className="font-mono text-sm font-medium text-mono-text">{value}</span>
            </div>
        );

        // StatGroup - grouped statistics with header
        const StatGroup = ({ title, children }) => (
            <div className="bg-mono-bg/30 rounded-xl p-3 border border-mono-light/10">
                <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">{title}</h4>
                <div className="space-y-1.5">{children}</div>
            </div>
        );

        // Metrics configuration
        const METRICS = [
            { id: 'inventory', label: 'Inventory' },
            { id: 'backorders', label: 'Backorders' },
            { id: 'incomingOrders', label: 'Incoming' },
            { id: 'outgoingOrders', label: 'Outgoing' },
            { id: 'holdingCost', label: 'Hold $' },
            { id: 'backorderCost', label: 'Back $' },
            { id: 'totalCost', label: 'Total $' },
        ];

        // StatisticsPanel - main statistics component with tabs
        const StatisticsPanel = ({ gameData }) => {
            const [activeMetric, setActiveMetric] = React.useState('inventory');
            const tabsRef = React.useRef(null);

            const metricValues = React.useMemo(() =>
                gameData.map(week => week[activeMetric] ?? 0), [gameData, activeMetric]);

            const stats = React.useMemo(() =>
                StatisticsCalculator.calculate(metricValues), [metricValues]);

            const fmt = (v, d = 2) => {
                if (v === '-' || v === 'None' || v === null) return v ?? '-';
                return typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(d)) : v;
            };

            const scrollTabs = (direction) => {
                const container = tabsRef.current;
                if (!container) return;
                const scrollAmount = 80;
                const newPos = direction === 'left'
                    ? Math.max(0, container.scrollLeft - scrollAmount)
                    : container.scrollLeft + scrollAmount;
                container.scrollTo({ left: newPos, behavior: 'smooth' });
            };

            return (
                <div className="flex flex-col w-full">
                    {/* Header with title and sample size */}
                    <div className="flex items-center justify-between mb-3 flex-shrink-0 gap-2">
                        <h3 className="font-semibold text-mono-text text-sm sm:text-base truncate">Statistics</h3>
                        <span className="text-[10px] text-mono-light uppercase tracking-wider whitespace-nowrap">n={gameData.length}</span>
                    </div>

                    {/* Metric Tabs - Single Row with Arrow Navigation */}
                    <div className="flex items-center gap-1 mb-4 pb-2 border-b border-mono-light/10 overflow-hidden flex-shrink-0">
                        <button onClick={() => scrollTabs('left')} className="p-0.5 text-mono-light hover:text-mono-text hover:bg-mono-bg/30 rounded transition-all flex-shrink-0">
                            <span className="material-symbols-outlined text-base">chevron_left</span>
                        </button>
                        <div ref={tabsRef} className="flex gap-1 overflow-x-scroll flex-1 min-w-0" style={{scrollbarWidth: 'none', msOverflowStyle: 'none', scrollBehavior: 'smooth'}}>
                            {METRICS.map(m => (
                                <button key={m.id} onClick={() => setActiveMetric(m.id)}
                                    className={`px-2 py-1 text-xs font-medium rounded transition-all whitespace-nowrap flex-shrink-0
                                        ${activeMetric === m.id
                                            ? 'bg-accent/20 text-accent border-b-2 border-accent'
                                            : 'text-mono-light hover:text-mono-text hover:bg-mono-bg/30'}`}>
                                    {m.label}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => scrollTabs('right')} className="p-0.5 text-mono-light hover:text-mono-text hover:bg-mono-bg/30 rounded transition-all flex-shrink-0">
                            <span className="material-symbols-outlined text-base">chevron_right</span>
                        </button>
                    </div>

                    {/* Statistics Grid - Single Column */}
                    <div className="grid grid-cols-1 gap-3">
                        <StatGroup title="Central Tendency">
                            <StatItem label="Mean" value={fmt(stats.mean)} />
                            <StatItem label="Median" value={fmt(stats.median)} />
                            <StatItem label="Mode" value={stats.mode} />
                        </StatGroup>

                        <StatGroup title="Dispersion">
                            <StatItem label="Min" value={fmt(stats.min, 0)} />
                            <StatItem label="Max" value={fmt(stats.max, 0)} />
                            <StatItem label="Range" value={fmt(stats.range, 0)} />
                            <StatItem label="Std Dev" value={fmt(stats.stdDev)} />
                        </StatGroup>

                        <StatGroup title="Distribution">
                            <StatItem label="CV" value={stats.coeffVar !== null ? `${fmt(stats.coeffVar)}%` : '-'} />
                            <StatItem label="Skewness" value={fmt(stats.skewness)} />
                            <StatItem label="Kurtosis" value={fmt(stats.kurtosis)} />
                            <StatItem label="IQR" value={fmt(stats.iqr)} />
                        </StatGroup>

                        <StatGroup title="Inference (95% CI)">
                            <StatItem label="Std Error" value={fmt(stats.sem)} />
                            <StatItem label="Margin" value={fmt(stats.marginError)} />
                            <StatItem label="CI Lower" value={fmt(stats.ci95Lower)} />
                            <StatItem label="CI Upper" value={fmt(stats.ci95Upper)} />
                        </StatGroup>
                    </div>
                </div>
            );
        };

        // MetricsPanel - KPI component showing key performance indicators
        const MetricsPanel = ({ gameData }) => {
            // Calculate metrics
            const metrics = React.useMemo(() => {
                if (!gameData || gameData.length === 0) return { totalCost: 0, serviceLevel: 0, fillRate: 0 };

                // Total Cost: final cumulative cost
                const totalCost = gameData[gameData.length - 1].totalCost;

                // Service Level: ratio of fully delivered orders to total orders
                // A fully delivered order is when outgoingOrders >= incomingOrders (orders)
                const fullyDeliveredOrders = gameData.filter(w => w.outgoingOrders >= w.incomingOrders).length;
                const serviceLevel = (fullyDeliveredOrders / gameData.length) * 100;

                // Fill Rate: ratio of total delivered to total ordered
                const totalDelivered = gameData.reduce((sum, w) => sum + w.outgoingOrders, 0);
                const totalOrdered = gameData.reduce((sum, w) => sum + w.incomingOrders, 0);
                const fillRate = totalOrdered > 0 ? (totalDelivered / totalOrdered) * 100 : 0;

                return { totalCost, serviceLevel, fillRate };
            }, [gameData]);

            return (
                <div className="flex flex-col h-full">
                    <h3 className="font-semibold mb-3 text-mono-text">Metrics</h3>

                    <div className="flex flex-col gap-4 flex-1">
                        {/* Total Cost */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Total Cost</h4>
                            <div className="text-3xl font-bold text-accent">${metrics.totalCost.toLocaleString()}</div>
                            <p className="text-[10px] text-mono-light mt-1">Cumulative holding + backorder costs</p>
                        </div>

                        {/* Service Level */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Service Level</h4>
                            <div className="text-3xl font-bold" style={{color: metrics.serviceLevel >= 80 ? '#fb923c' : metrics.serviceLevel >= 50 ? '#F97316' : '#f87171'}}>
                                {metrics.serviceLevel.toFixed(1)}%
                            </div>
                            <p className="text-[10px] text-mono-light mt-1">Fully delivered orders / total orders</p>
                        </div>

                        {/* Fill Rate */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Fill Rate</h4>
                            <div className="text-3xl font-bold" style={{color: metrics.fillRate >= 90 ? '#fb923c' : metrics.fillRate >= 70 ? '#F97316' : '#f87171'}}>
                                {metrics.fillRate.toFixed(1)}%
                            </div>
                            <p className="text-[10px] text-mono-light mt-1">Delivered quantity / ordered quantity</p>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardCharts = () => {
            // Orders vs Inventory chart toggles
            const [showOrders, setShowOrders] = React.useState(true);
            const [showInventory, setShowInventory] = React.useState(true);
            const [showBackorders, setShowBackorders] = React.useState(true);
            // Cost chart toggles
            const [showHoldingCost, setShowHoldingCost] = React.useState(true);
            const [showBackorderCost, setShowBackorderCost] = React.useState(true);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full h-full">
                    {/* LEFT COLUMN - Charts stacked vertically */}
                    <div className="flex flex-col gap-6">
                        {/* Orders vs Inventory Chart */}
                        <div className="bg-mono-surface p-2 sm:p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1">
                            {/* Header with title and toggles */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 sm:mb-4">
                                <h3 className="font-semibold text-mono-text text-sm sm:text-base">Orders vs. Inventory</h3>
                                <div className="flex items-center gap-2 sm:gap-3">
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showInventory}
                                            onChange={(e) => setShowInventory(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/50 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs" style={{color: '#F97316'}}>Inventory</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showBackorders}
                                            onChange={(e) => setShowBackorders(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/90 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/90">Backorders</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer sm:ml-auto">
                                        <input
                                            type="checkbox"
                                            checked={showOrders}
                                            onChange={(e) => setShowOrders(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/10 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/30">Orders</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex-1 w-full min-h-[180px] sm:min-h-[200px] bg-accent/5 border border-accent/10 rounded-lg overflow-hidden">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={data} margin={{ top: 20, right: 15, left: 5, bottom: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#404040" vertical={false} />
                                        <XAxis dataKey="week" stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Week', position: 'bottom', offset: 0, fill: '#808080', fontSize: 10 }} />
                                        <YAxis stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Units', position: 'insideTopLeft', fill: '#808080', fontSize: 10, dy: -15 }} />
                                        <Tooltip content={<CustomTooltip />} />
                                        {showOrders && <Bar dataKey="outgoingOrders" name="Orders" fill="rgba(249, 115, 22, 0.1)" barSize={12} radius={[2, 2, 0, 0]} />}
                                        {showInventory && <Line type="monotone" dataKey="inventory" name="Inventory" stroke="#F97316" strokeWidth={3} dot={{r: 3, fill: '#F97316'}} activeDot={{r: 6}} />}
                                        {showBackorders && <Line type="monotone" dataKey="backorders" name="Backorders" stroke="rgba(249, 115, 22, 0.9)" strokeWidth={2} dot={{r: 3, fill: 'rgba(249, 115, 22, 0.9)'}} activeDot={{r: 5}} />}
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* Cost Accumulation Chart - Stacked */}
                        <div className="bg-mono-surface p-2 sm:p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1">
                            {/* Header with title and toggles */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 sm:mb-4">
                                <h3 className="font-semibold text-mono-text text-sm sm:text-base">Cost Accumulation</h3>
                                <div className="flex items-center gap-2 sm:gap-4">
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showHoldingCost}
                                            onChange={(e) => setShowHoldingCost(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/50 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs" style={{color: '#F97316'}}>Holding</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showBackorderCost}
                                            onChange={(e) => setShowBackorderCost(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/90 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/90">Backorder</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex-1 w-full min-h-[180px] sm:min-h-[200px] bg-accent/5 border border-accent/10 rounded-lg overflow-hidden">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={data} margin={{ top: 20, right: 15, left: 5, bottom: 20 }}>
                                        <defs>
                                            <linearGradient id="colorHoldingCostFactory" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#F97316" stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor="#F97316" stopOpacity={0.2}/>
                                            </linearGradient>
                                            <linearGradient id="colorBackorderCostFactory" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="rgba(249, 115, 22, 0.9)" stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor="rgba(249, 115, 22, 0.9)" stopOpacity={0.2}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#404040" vertical={false} />
                                        <XAxis dataKey="week" stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Week', position: 'bottom', offset: 0, fill: '#808080', fontSize: 10 }} />
                                        <YAxis stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Cost ($)', position: 'insideTopLeft', fill: '#808080', fontSize: 10, dy: -15 }} />
                                        <Tooltip content={<CustomTooltip />} />
                                        {showHoldingCost && <Area type="monotone" dataKey="cumHoldingCost" name="Holding Cost ($)" stackId="1" stroke="#F97316" fillOpacity={1} fill="url(#colorHoldingCostFactory)" />}
                                        {showBackorderCost && <Area type="monotone" dataKey="cumBackorderCost" name="Backorder Cost ($)" stackId="1" stroke="rgba(249, 115, 22, 0.9)" fillOpacity={1} fill="url(#colorBackorderCostFactory)" />}
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT COLUMN - Metrics and Statistics Panels side-by-side */}
                    <div className="flex flex-col md:flex-row gap-4">
                        {/* Metrics Panel - Half Width */}
                        <div className="bg-mono-surface p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1 min-w-0 overflow-hidden">
                            <MetricsPanel gameData={data} />
                        </div>
                        {/* Statistics Panel - Half Width */}
                        <div className="bg-mono-surface p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1 min-w-0">
                            <StatisticsPanel gameData={data} />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('charts-root'));
        root.render(<DashboardCharts />);
    </script>
</body></html>
