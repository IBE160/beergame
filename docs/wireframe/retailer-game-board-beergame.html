<!DOCTYPE html>
<html class="" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Beer Game - Retailer Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

<!-- React & Recharts Dependencies -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
<script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        'mono-bg': '#1A1A1A', // Dark charcoal/black background
                        'mono-surface': '#2C2C2C', // Slightly lighter dark gray for cards/surfaces
                        'mono-text': '#E0E0E0', // Light gray for primary text
                        'mono-light': '#808080', // Medium gray for secondary text/borders
                        'accent': '#FFD700', // Gold/Amber as the contrasting accent color
                    },
                    fontFamily: {
                        sans: ["Inter", "system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "sans-serif"],
                        mono: ["Roboto Mono", "monospace"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem", // Sharper corners for a modern look
                        'sm': "0.125rem",
                        'md': "0.375rem",
                        'lg': "0.5rem",
                        'xl': "0.75rem",
                        'full': "9999px",
                    },
                    borderWidth: {
                        '1': '1px',
                    }
                },
            },
        };
    </script>
<style type="text/tailwindcss">body {
            @apply font-sans bg-mono-bg text-mono-text antialiased;
        }.flow-pipe {
            @apply absolute bg-mono-light opacity-50 transition-all duration-300 ease-out;
        }
        .flow-pipe.active {
            @apply bg-accent opacity-100;
        }
        .flow-pipe.vertical {
            @apply w-[2px] h-1/2;
        }
        .flow-pipe.horizontal {
            @apply h-[2px] w-1/2;
        }
        .flow-pipe.arrow-end::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            @apply opacity-0 transition-opacity duration-300 ease-out;
        }
        .flow-pipe.arrow-end.active::after {
             @apply opacity-100;
        }
        .flow-pipe.arrow-down::after {
            border-width: 6px 4px 0 4px;border-color: var(--tw-bg-accent) transparent transparent transparent;
            left: 50%;
            bottom: -6px;transform: translateX(-50%);
        }
        .flow-pipe.arrow-up::after {
            border-width: 0 4px 6px 4px;border-color: transparent transparent var(--tw-bg-accent) transparent;
            left: 50%;
            top: -6px;transform: translateX(-50%);
        }
        .flow-pipe.arrow-right::after {
            border-width: 4px 0 4px 6px;border-color: transparent transparent transparent var(--tw-bg-accent);
            top: 50%;
            right: -6px;transform: translateY(-50%);
        }
        .flow-pipe.arrow-left::after {
            border-width: 4px 6px 4px 0;border-color: transparent var(--tw-bg-accent) transparent transparent;
            top: 50%;
            left: -6px;transform: translateY(-50%);
        }
        /* Hide numeric spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="font-sans bg-mono-bg text-mono-text antialiased overflow-x-auto">
    <div class="w-full min-w-[400px] h-screen p-6 overflow-auto">
        <div class="flex-1 flex flex-col w-full max-w-[1600px] mx-auto relative z-10 space-y-6 px-6">
            
            <!-- MAIN GAME BOARD (Sketch Implementation) -->
            <div class="w-full bg-mono-surface/40 backdrop-blur-md border border-mono-light/10 rounded-2xl p-4 min-[780px]:p-6 lg:p-8 shadow-2xl flex flex-col-reverse min-[780px]:flex-row items-stretch min-[780px]:justify-between gap-4 min-[780px]:gap-0 relative overflow-hidden">
                
                <!-- 1. LEFT NODE: WHOLESALER -->
                <div class="w-full min-[780px]:w-40 lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-20 group">
                    <!-- Header - hidden on mobile -->
                    <div class="hidden min-[780px]:block p-3 lg:p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-xs lg:text-sm uppercase tracking-widest font-bold text-center">Wholesaler</h3>
                    </div>

                    <!-- Mobile: Title (centered) + Order slot (absolute right) in top row -->
                    <div class="min-[780px]:hidden relative p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Wholesaler</h3>
                        <!-- Mobile Order Box - aligned with right pipe -->
                        <div class="absolute top-3 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-dashed border-accent/30 p-1 rounded shadow-lg">
                            <div class="text-[8px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div class="mobile-wholesaler-order-value bg-accent/10 px-2 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center text-xs min-w-[40px] h-6">&nbsp;</div>
                        </div>
                    </div>

                    <div class="flex-1 flex items-center justify-center pt-2 min-[780px]:pt-[34px] p-3 min-[780px]:p-4 relative flex-col">
                         <!-- Faint background icon -->
                         <span class="material-symbols-outlined text-7xl min-[780px]:text-9xl text-mono-light/5 absolute opacity-[0.03] top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">warehouse</span>

                         <!-- Hidden Inventory Box (Wholesaler) -->
                         <div id="wholesaler-inventory" class="bg-mono-bg/30 p-3 lg:p-4 mt-0 min-[780px]:mt-[15px] rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] min-[780px]:min-w-[120px] min-h-[80px] min-[780px]:min-h-[100px] relative z-10 cursor-help" title="Hidden Information">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-3xl lg:text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">&nbsp;</div>
                        </div>
                    </div>
                    <!-- Incoming Order Box (Bottom) - tablet/desktop only -->
                    <div class="hidden min-[780px]:flex p-3 bg-mono-surface rounded-b-xl justify-end">
                         <div class="bg-mono-surface border border-dashed border-accent/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div id="wholesaler-order-value" class="bg-accent/10 px-2 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center text-xs min-w-[40px] h-6">&nbsp;</div>
                        </div>
                    </div>
                </div>

                <!-- PIPE SECTION 1: Wholesaler -> Retailer (Hidden on mobile) -->
                <div class="hidden min-[780px]:flex flex-1 flex-col justify-between py-4 relative min-w-[100px] lg:min-w-[200px]">

                    <!-- Top Pipe: Deliveries (Rightward) -->
                    <div class="relative h-12 lg:h-16 top-[30px] lg:top-[40px] w-full flex items-center">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 mt-[2px] h-[30px] lg:h-[40px] bg-mono-surface rounded-none"></div>

                        <!-- Delay Boxes (Sitting on pipe) -->
                        <div class="absolute w-full flex justify-center px-2 z-10 top-0 -mt-[3px] gap-2">
                             <!-- Week 1 -->
                             <div class="bg-mono-surface border border-green-500/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center">W1</div>
                                <div id="delivery-week-1" class="bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20 text-green-400 font-sans font-bold text-center text-xs min-w-[30px]">20</div>
                            </div>
                             <!-- Week 2 -->
                             <div class="bg-mono-surface border border-green-500/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center">W2</div>
                                <div id="delivery-week-2" class="bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20 text-green-400 font-sans font-bold text-center text-xs min-w-[30px]">30</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Pipe: Orders (Leftward) -->
                    <div class="relative h-12 lg:h-16 w-full flex items-center top-[5px]">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[30px] lg:h-[40px] bg-mono-surface rounded-none"></div>
                    </div>
                </div>

                <!-- MOBILE VERTICAL CONNECTOR 1: Wholesaler -> Retailer -->
                <div class="flex min-[780px]:hidden flex-row items-stretch justify-between w-full px-[calc(25%-51px)] -my-5">
                    <!-- Left pipe with W1/W2 boxes -->
                    <div class="flex flex-col items-center justify-evenly">
                        <!-- Vertical pipe line (top) - reaches role box -->
                        <div class="w-[46px] h-5 bg-mono-surface"></div>
                        <!-- W1 box -->
                        <div class="w-[52px] bg-mono-surface border border-green-500/30 rounded p-1">
                            <div class="text-[8px] text-mono-text uppercase text-center">W1</div>
                            <div class="bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20 text-green-400 font-sans font-bold text-center text-xs min-w-[30px]">20</div>
                        </div>
                        <!-- Pipe between W1 and W2 -->
                        <div class="w-[46px] flex-1 min-h-[8px] bg-mono-surface"></div>
                        <!-- W2 box -->
                        <div class="w-[52px] bg-mono-surface border border-green-500/30 rounded p-1">
                            <div class="text-[8px] text-mono-text uppercase text-center">W2</div>
                            <div class="bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20 text-green-400 font-sans font-bold text-center text-xs min-w-[30px]">30</div>
                        </div>
                        <!-- Vertical pipe line (bottom) - reaches role box -->
                        <div class="w-[46px] h-5 bg-mono-surface"></div>
                    </div>
                    <!-- Right pipe - continuous, no slots -->
                    <div class="w-[46px] self-stretch bg-mono-surface"></div>
                </div>

                <!-- 2. CENTER NODE: INVENTORY (RETAILER) -->
                <div class="w-full min-[780px]:w-40 lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-30">

                    <!-- Header - hidden on mobile -->
                    <div class="hidden min-[780px]:block p-3 lg:p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-xs lg:text-sm uppercase tracking-widest font-bold text-center">Retailer</h3>
                    </div>

                    <!-- Mobile: Title (centered) + Demand slot (absolute right) in top row -->
                    <div class="min-[780px]:hidden relative p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Retailer</h3>
                        <!-- Mobile Demand Box (upper right, absolute) -->
                        <div class="absolute top-3 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-dashed border-red-500/30 p-1 rounded shadow-lg">
                            <div class="text-[8px] text-mono-text uppercase text-center mb-1">Demand</div>
                            <div class="mobile-retailer-demand-value bg-red-500/10 px-2 py-1 rounded border border-red-500/20 text-red-400 font-sans font-bold text-center text-xs min-w-[40px] h-6">&nbsp;</div>
                        </div>
                    </div>

                    <!-- Inventory Display (Wrapped Box) -->
                    <div class="flex-1 flex items-center justify-center pt-1 min-[780px]:pt-[34px] p-2 min-[780px]:p-4 lg:p-6">
                         <div id="retailer-inventory" class="bg-mono-bg/30 p-2 min-[780px]:p-3 lg:p-4 mt-0 min-[780px]:mt-[15px] rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] min-[780px]:min-w-[120px] min-h-[60px] min-[780px]:min-h-[100px]">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-3xl lg:text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">50</div>
                        </div>
                    </div>

                    <!-- Bottom Section: Order (Left) & Demand (Right) - Hidden on mobile -->
                    <div class="hidden min-[780px]:flex p-3 min-[780px]:p-4 bg-mono-surface rounded-b-xl justify-between items-end gap-1 min-[780px]:gap-2 relative">

                        <!-- Order Section with Send Button (tablet/desktop) -->
                        <div class="flex flex-col items-center gap-1">
                            <button class="w-full bg-transparent border border-accent hover:bg-accent/10 text-white rounded py-0.5 shadow-md transition-colors flex items-center justify-center">
                                <span class="text-[8px] font-bold uppercase">Send</span>
                            </button>

                            <!-- Order Input (Numeric Up/Down) -->
                             <div class="bg-mono-surface border border-dashed border-accent/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div id="retailer-order-value" class="bg-accent/10 px-1 py-0 rounded border border-accent/20 flex items-center justify-center min-w-[40px] h-6">
                                    <input type="number" value="30" id="orderInput" min="0" class="w-5 bg-transparent text-center font-sans font-bold text-accent text-xs border-0 p-0 focus:ring-0 appearance-none" />
                                    <div class="flex flex-col ml-0.5">
                                        <button id="btnUp" class="text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_up</span></button>
                                        <button id="btnDown" class="text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_down</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Script for Order Input Logic & Animations -->
                        <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                // Desktop elements
                                const orderInput = document.getElementById('orderInput');
                                const btnUp = document.getElementById('btnUp');
                                const btnDown = document.getElementById('btnDown');
                                const btnSend = document.querySelector('.hidden.sm\\:flex button.w-full.bg-transparent.border-accent');

                                // Mobile elements
                                const mobileOrderInput = document.querySelector('.mobile-order-input');
                                const mobileBtnUp = document.querySelector('.mobile-btn-up');
                                const mobileBtnDown = document.querySelector('.mobile-btn-down');
                                const mobileBtnSend = document.querySelector('.mobile-btn-send');
                                const mobileRetailerDemand = document.querySelector('.mobile-retailer-demand-value');
                                const mobileCustomerDemand = document.querySelector('.mobile-customer-demand');
                                const mobileWholesalerOrder = document.querySelector('.mobile-wholesaler-order-value');

                                // --- Get Elements by ID ---
                                const els = {
                                    wholesalerOrderInner: document.getElementById('wholesaler-order-value'),
                                    retailerOrderInner: document.getElementById('retailer-order-value'),
                                    retailerInventory: document.getElementById('retailer-inventory'),
                                    greenWeek1: document.getElementById('delivery-week-1'),
                                    greenWeek2: document.getElementById('delivery-week-2'),
                                    yellowWeek1: document.getElementById('outgoing-week-1'),
                                    yellowWeek2: document.getElementById('outgoing-week-2'),
                                    retailerDemand: document.getElementById('retailer-demand'),
                                    retailerDemandInner: document.getElementById('retailer-demand-value'),
                                    customerDemand: document.getElementById('customer-demand'),
                                    customerIcons: document.getElementById('customer-icons'),
                                    wholesalerInventory: document.getElementById('wholesaler-inventory')
                                };

                                // --- Mobile Detection ---
                                const isMobile = () => window.innerWidth < 640;

                                // --- Get current order input based on screen size ---
                                const getCurrentOrderInput = () => isMobile() ? mobileOrderInput : orderInput;
                                const getCurrentBtnSend = () => isMobile() ? mobileBtnSend : btnSend;

                                // --- Input Logic ---
                                const validateInput = () => {
                                    const currentInput = getCurrentOrderInput();
                                    const currentBtn = getCurrentBtnSend();
                                    const val = currentInput?.value;
                                    const isEmpty = val === '' || val === null;

                                    if (currentBtn) {
                                        if (isEmpty) {
                                            currentBtn.disabled = true;
                                            currentBtn.classList.add('opacity-50', 'cursor-not-allowed');
                                            currentBtn.classList.remove('hover:bg-accent/10');
                                        } else {
                                            currentBtn.disabled = false;
                                            currentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                            currentBtn.classList.add('hover:bg-accent/10');
                                        }
                                    }
                                };

                                // Desktop input handlers
                                if (btnUp) btnUp.addEventListener('click', () => { orderInput.stepUp(); validateInput(); });
                                if (btnDown) btnDown.addEventListener('click', () => { orderInput.stepDown(); validateInput(); });
                                if (orderInput) {
                                    orderInput.addEventListener('input', validateInput);
                                    orderInput.addEventListener('change', () => {
                                        if (orderInput.value < 0) orderInput.value = 0;
                                        validateInput();
                                    });
                                }

                                // Mobile input handlers
                                if (mobileBtnUp) mobileBtnUp.addEventListener('click', () => { mobileOrderInput.stepUp(); validateInput(); });
                                if (mobileBtnDown) mobileBtnDown.addEventListener('click', () => { mobileOrderInput.stepDown(); validateInput(); });
                                if (mobileOrderInput) {
                                    mobileOrderInput.addEventListener('input', validateInput);
                                    mobileOrderInput.addEventListener('change', () => {
                                        if (mobileOrderInput.value < 0) mobileOrderInput.value = 0;
                                        validateInput();
                                    });
                                }

                                validateInput();

                                // --- Animation Logic ---
                                window.startState3Animation = () => {
                                    console.log("Starting State 3 Animations (Order + Green Week 2)...");

                                    // Skip animations on mobile - just update values directly
                                    if (isMobile()) {
                                        console.log("Mobile detected - skipping animations, updating values directly");
                                        // Update values without animation using mobile input
                                        const orderVal = mobileOrderInput?.value || '0';
                                        if (els.wholesalerOrderInner) els.wholesalerOrderInner.innerText = orderVal;
                                        if (mobileWholesalerOrder) mobileWholesalerOrder.innerText = orderVal;
                                        if (mobileOrderInput) mobileOrderInput.value = '';

                                        // Shift delivery pipeline (mobile connector boxes don't have IDs, just display)
                                        const week1Val = els.greenWeek1?.innerText || '0';
                                        const week2Val = els.greenWeek2?.innerText || '0';
                                        if (els.greenWeek1) els.greenWeek1.innerText = '0';
                                        if (els.greenWeek2) els.greenWeek2.innerText = week1Val;

                                        // Update inventory (add week2 delivery)
                                        const invEl = els.retailerInventory?.querySelector('.text-3xl, .lg\\:text-5xl');
                                        if (invEl) {
                                            const currentInv = parseInt(invEl.innerText) || 0;
                                            invEl.innerText = currentInv + parseInt(week2Val || 0);
                                        }

                                        // Shift outgoing pipeline
                                        const outWeek1Val = els.yellowWeek1?.innerText || '0';
                                        if (els.yellowWeek1) els.yellowWeek1.innerText = '0';
                                        if (els.yellowWeek2) els.yellowWeek2.innerText = outWeek1Val;

                                        // Generate random demand and update both mobile and desktop elements
                                        const randomDemand = Math.floor(Math.random() * 11) + 10;
                                        if (els.retailerDemandInner) els.retailerDemandInner.innerText = randomDemand;
                                        if (mobileRetailerDemand) mobileRetailerDemand.innerText = randomDemand;
                                        if (els.customerDemand) els.customerDemand.innerText = randomDemand;
                                        if (mobileCustomerDemand) mobileCustomerDemand.innerText = randomDemand;

                                        // Re-enable mobile interface
                                        if (mobileOrderInput) mobileOrderInput.disabled = false;
                                        if (mobileBtnUp) mobileBtnUp.disabled = false;
                                        if (mobileBtnDown) mobileBtnDown.disabled = false;
                                        if (mobileBtnSend) {
                                            mobileBtnSend.querySelector('span').innerText = "Send";
                                            mobileBtnSend.disabled = false;
                                            mobileBtnSend.classList.remove('opacity-50', 'cursor-not-allowed');
                                            validateInput();
                                        }
                                        return;
                                    }

                                    // Helper to clone and animate
                                    const animateClone = (sourceEl, targetEl, textOverride = null, pathType = 'direct', onComplete = null, persist = false, overwrite = false) => {
                                        if (!sourceEl || !targetEl) {
                                            console.error("Animation Source or Target missing", { sourceEl, targetEl });
                                            return;
                                        }
                                        
                                        const rectSource = sourceEl.getBoundingClientRect();
                                        const rectTarget = targetEl.getBoundingClientRect();
                                        
                                        // Create Ghost
                                        const clone = sourceEl.cloneNode(true);
                                        
                                        // Clean up clone IDs/inputs
                                        clone.id = '';
                                        const input = clone.querySelector('input');
                                        if (input) {
                                            const val = input.value;
                                            const span = document.createElement('span');
                                            span.innerText = val;
                                            span.className = input.className.replace('bg-transparent', ''); 
                                            span.style.display = 'inline-block';
                                            input.replaceWith(span);
                                            const btns = clone.querySelectorAll('button');
                                            btns.forEach(b => b.remove());
                                        }
                                        
                                        if (textOverride !== null) {
                                            const numberDiv = clone.querySelector('.font-bold') || clone;
                                            numberDiv.innerText = textOverride;
                                        }

                                        // Style Ghost
                                        clone.style.position = 'fixed';
                                        clone.style.left = `${rectSource.left}px`;
                                        clone.style.top = `${rectSource.top}px`;
                                        clone.style.width = `${rectSource.width}px`;
                                        clone.style.height = `${rectSource.height}px`;
                                        clone.style.margin = '0';
                                        clone.style.zIndex = '9999';
                                        clone.style.pointerEvents = 'none';
                                        clone.style.transition = 'none';
                                        document.body.appendChild(clone);

                                        // Calculate Keyframes
                                        let keyframes;
                                        const deltaX = rectTarget.left - rectSource.left;
                                        const deltaY = rectTarget.top - rectSource.top;

                                        if (pathType === 'dogleg') {
                                            // Horizontal to left border, then down to center
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                                            
                                            const waypointX = deltaX; // Align left edges
                                            const finalX = deltaX + centerOffsetX; // Center in box
                                            const finalY = deltaY + centerOffsetY; // Center in box
                                            
                                            keyframes = [
                                                { transform: 'translate(0, 0)', offset: 0 },
                                                { transform: `translate(${waypointX}px, 0)`, offset: 0.6 },
                                                { transform: `translate(${finalX}px, ${finalY}px)`, offset: 1 }
                                            ];
                                        } else if (pathType === 'vertical-dogleg') {
                                            // Vertical first, then horizontal
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                                            
                                            const finalX = deltaX + centerOffsetX;
                                            const finalY = deltaY + centerOffsetY;
                                            // Move vertically to target's Y level (plus centering)
                                            const adjustedY = finalY;
                                            
                                            keyframes = [
                                                { transform: 'translate(0, 0)', offset: 0 },
                                                { transform: `translate(0, ${adjustedY}px)`, offset: 0.6 },
                                                { transform: `translate(${finalX}px, ${adjustedY}px)`, offset: 1 }
                                            ];
                                        } else if (pathType === 'vertical-align-y') {
                                            // Vertical only, align to target's Y center, preserve Source X
                                            const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                                            const finalY = deltaY + centerOffsetY;

                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(0, ${finalY}px)` }
                                            ];
                                        } else if (pathType === 'horizontal') {
                                            // Horizontal only, keep Y at 0, center at target
                                            const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                                            const finalX = deltaX + centerOffsetX;
                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(${finalX}px, 0)` }
                                            ];
                                        } else {
                                            // Direct path
                                            keyframes = [
                                                { transform: 'translate(0, 0)' },
                                                { transform: `translate(${deltaX}px, ${deltaY}px)` }
                                            ];
                                        }

                                        // Animate
                                        const animation = clone.animate(keyframes, {
                                            duration: 2000,
                                            easing: 'ease-in-out',
                                            fill: 'forwards'
                                        });

                                        animation.onfinish = () => {
                                            if (!persist) clone.remove();
                                            // Optional: update target text
                                            if (overwrite || targetEl.innerText.trim() === '' || targetEl.innerText.trim() === '&nbsp;') {
                                                targetEl.innerText = input ? input.value : clone.innerText.trim();
                                            }
                                            if (onComplete) onComplete(clone);
                                        };
                                    };

                                    // 1. Retailer Order -> Wholesaler Order (Direct)
                                    animateClone(els.retailerOrderInner, els.wholesalerOrderInner, null, 'direct', () => {
                                        // PHASE 2: Wholesaler Order -> Middle of Inventory (Vertical Align Y)
                                        // Clone moves up to align with Inventory Y, but keeps Order X (right side)
                                        setTimeout(() => {
                                            if (els.wholesalerOrderInner && els.wholesalerInventory) {
                                                animateClone(els.wholesalerOrderInner, els.wholesalerInventory, null, 'vertical-align-y', (persistedClone) => {
                                                    // PHASE 3: Morph & Move to Week 1
                                                    setTimeout(() => {
                                                        if (!persistedClone) return;
                                                        
                                                        // 1. Morph into Green Delivery
                                                        persistedClone.classList.remove('bg-accent/10', 'border-accent/20', 'text-accent');
                                                        persistedClone.classList.add('bg-green-500/10', 'border-green-500/20', 'text-green-400');
                                                        
                                                        // Calculate & Update Value
                                                        const valSpan = persistedClone.querySelector('span') || persistedClone.querySelector('.font-bold') || persistedClone;
                                                        const orderVal = parseInt(valSpan.innerText) || 0;
                                                        const deliverVal = Math.min(25, orderVal);
                                                        valSpan.innerText = deliverVal;

                                                        // 2. Move to Week 1 (Vertical Dogleg: Up then Right)
                                                        if (els.greenWeek1) {
                                                            // Start animation from the mutated clone's current position
                                                            animateClone(persistedClone, els.greenWeek1, deliverVal, 'vertical-dogleg', () => {
                                                                els.greenWeek1.innerText = deliverVal;
                                                                els.greenWeek1.style.opacity = '1';
                                                            });
                                                            // Remove the intermediate clone as the new moving clone takes over
                                                            persistedClone.remove();
                                                        }
                                                    }, 1000);
                                                }, true);
                                            }
                                        }, 1000);
                                    }, false, true); // persist=false, overwrite=true
                                    // Clear source Retailer Order immediately as it "moves"
                                    const orderInput = els.retailerOrderInner.querySelector('input');
                                    if (orderInput) orderInput.value = ''; 

                                    // 2. Green Week 2 -> Retailer Inventory (Dogleg)
                                    animateClone(els.greenWeek2, els.retailerInventory, null, 'dogleg', () => {
                                        // Update Inventory to 80 (50 + 30)
                                        const invNumber = els.retailerInventory.querySelector('.text-5xl');
                                        if (invNumber) invNumber.innerText = '80';
                                    });
                                    // Hide source Green Week 2 number immediately
                                    els.greenWeek2.style.opacity = '0';

                                    // 3. Green Week 1 -> Green Week 2
                                    if (els.greenWeek1 && els.greenWeek2) {
                                        const val = els.greenWeek1.innerText;
                                        animateClone(els.greenWeek1, els.greenWeek2, null, 'direct', () => {
                                            // Update Week 2 with Week 1's value and show it
                                            els.greenWeek2.innerText = val;
                                            els.greenWeek2.style.opacity = '1';
                                        });
                                        // Hide source Week 1 number immediately
                                        els.greenWeek1.style.opacity = '0';
                                    }

                                    // 4. Yellow Week 2 -> Customer (Market Demand area)
                                    if (els.yellowWeek2 && els.customerIcons) {
                                        animateClone(els.yellowWeek2, els.customerIcons, null, 'dogleg');
                                        // Hide source number immediately
                                        els.yellowWeek2.style.opacity = '0';
                                    }

                                    // 5. Yellow Week 1 -> Yellow Week 2
                                    if (els.yellowWeek1 && els.yellowWeek2) {
                                        const val = els.yellowWeek1.innerText;
                                        animateClone(els.yellowWeek1, els.yellowWeek2, null, 'direct', () => {
                                            // Update Week 2 with Week 1's value and show it
                                            els.yellowWeek2.innerText = val;
                                            els.yellowWeek2.style.opacity = '1';
                                        });
                                        // Hide source Week 1 number immediately
                                        els.yellowWeek1.style.opacity = '0';
                                    }

                                    // 6. Customer Demand -> Retailer Demand
                                    if (els.customerDemand && els.retailerDemand) {
                                        // Random Demand 10-20
                                        const randomDemand = Math.floor(Math.random() * 11) + 10;
                                        
                                        animateClone(els.customerDemand, els.retailerDemand, randomDemand.toString(), 'horizontal', () => {
                                            const targetNum = els.retailerDemand.querySelector('.font-bold');
                                            if (targetNum) targetNum.innerText = randomDemand;

                                            // Phase 3: Retailer Demand -> Middle of Inventory (Vertical Align Y)
                                            // Imitates Wholesaler Order movements
                                            setTimeout(() => {
                                                if (els.retailerDemandInner && els.retailerInventory) {
                                                    animateClone(els.retailerDemandInner, els.retailerInventory, null, 'vertical-align-y', (persistedClone) => {
                                                        // Phase 4: Morph & Move to Yellow Week 1
                                                        setTimeout(() => {
                                                            if (!persistedClone) return;

                                                            // 1. Morph into Yellow Delivery Order
                                                            // Remove red demand styles
                                                            persistedClone.classList.remove('bg-red-500/10', 'border-red-500/20', 'text-red-400');
                                                            // Add yellow accent styles
                                                            persistedClone.classList.add('bg-accent/10', 'border-accent/20', 'text-accent');

                                                            // Calculate & Update Value: Min(CurrentInv, Demand)
                                                            const valSpan = persistedClone.querySelector('span') || persistedClone.querySelector('.font-bold') || persistedClone;
                                                            // Use the randomDemand we generated
                                                            const demandVal = randomDemand;
                                                            
                                                            // Get current inventory to calculate delivery cap
                                                            const invNumber = els.retailerInventory.querySelector('.text-5xl');
                                                            let currentInv = 0;
                                                            if (invNumber) currentInv = parseInt(invNumber.innerText) || 0;

                                                            const deliverVal = Math.min(currentInv, demandVal);
                                                            valSpan.innerText = deliverVal;

                                                            // Decrease Inventory Level
                                                            if (invNumber) {
                                                                invNumber.innerText = Math.max(0, currentInv - deliverVal);
                                                            }

                                                            // 2. Move to Yellow Week 1 (Vertical Dogleg: Up then Right)
                                                            if (els.yellowWeek1) {
                                                                animateClone(persistedClone, els.yellowWeek1, deliverVal, 'vertical-dogleg', () => {
                                                                    els.yellowWeek1.innerText = deliverVal;
                                                                    els.yellowWeek1.style.opacity = '1';

                                                                    // Reset Interface for Next Round
                                                                    if (orderInput) orderInput.disabled = false;
                                                                    if (btnUp) btnUp.disabled = false;
                                                                    if (btnDown) btnDown.disabled = false;

                                                                    if (btnSend) {
                                                                        btnSend.querySelector('span').innerText = "Send";
                                                                        validateInput();
                                                                    }
                                                                });
                                                                // Remove the intermediate clone
                                                                persistedClone.remove();
                                                            }
                                                        }, 1000);
                                                    }, true);
                                                }
                                            }, 1000);
                                        });
                                    }
                                };

                                // --- Send Button Logic ---
                                // Desktop send button handler
                                if (btnSend) {
                                    btnSend.addEventListener('click', () => {
                                        // State 1 -> Transition
                                        orderInput.disabled = true;
                                        btnUp.disabled = true;
                                        btnDown.disabled = true;
                                        btnSend.disabled = true;

                                        btnSend.querySelector('span').innerText = "WAIT";
                                        btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                                        btnSend.classList.remove('hover:bg-accent/10');

                                        setTimeout(() => {
                                            // State 2: Sent/Waiting
                                            btnSend.querySelector('span').innerText = "SENT";
                                            console.log("Transition to State 2 complete. Order locked.");

                                            // Trigger State 3
                                            startState3Animation();
                                        }, 5000);
                                    });
                                }

                                // Mobile send button handler
                                if (mobileBtnSend) {
                                    mobileBtnSend.addEventListener('click', () => {
                                        // State 1 -> Transition
                                        mobileOrderInput.disabled = true;
                                        mobileBtnUp.disabled = true;
                                        mobileBtnDown.disabled = true;
                                        mobileBtnSend.disabled = true;

                                        mobileBtnSend.querySelector('span').innerText = "WAIT";
                                        mobileBtnSend.classList.add('opacity-50', 'cursor-not-allowed');
                                        mobileBtnSend.classList.remove('hover:bg-accent/10');

                                        // Shorter delay on mobile (no animations)
                                        setTimeout(() => {
                                            // State 2: Sent/Waiting
                                            mobileBtnSend.querySelector('span').innerText = "SENT";
                                            console.log("Mobile: Transition to State 2 complete. Order locked.");

                                            // Trigger State 3
                                            startState3Animation();
                                        }, 500);
                                    });
                                }
                            });
                        </script>

                        <!-- Demand Box (Right, Dashed) - tablet/desktop -->
                         <div id="retailer-demand" class="bg-mono-surface border border-dashed border-red-500/30 p-1 rounded shadow-lg">
                            <div class="text-[8px] text-mono-text uppercase text-center mb-1">Demand</div>
                            <div id="retailer-demand-value" class="bg-red-500/10 px-2 py-1 rounded border border-red-500/20 text-red-400 font-sans font-bold text-center text-xs min-w-[40px] h-6">&nbsp;</div>
                        </div>
                    </div>

                    <!-- Mobile: Order Box at bottom - aligned with right pipe -->
                    <div class="min-[780px]:hidden p-2 pt-0 bg-mono-surface rounded-b-xl flex justify-end pr-[calc(25%-28px)]">
                        <div class="flex flex-col items-center gap-1 translate-x-1/2">
                            <button class="mobile-btn-send w-full bg-transparent border border-accent hover:bg-accent/10 text-white rounded py-0.5 shadow-md transition-colors flex items-center justify-center">
                                <span class="text-[8px] font-bold uppercase">Send</span>
                            </button>
                            <div class="bg-mono-surface border border-dashed border-accent/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div class="bg-accent/10 px-1 py-0 rounded border border-accent/20 flex items-center justify-center min-w-[40px] h-6">
                                    <input type="number" value="30" min="0" class="mobile-order-input w-5 bg-transparent text-center font-sans font-bold text-accent text-xs border-0 p-0 focus:ring-0 appearance-none" />
                                    <div class="flex flex-col ml-0.5">
                                        <button class="mobile-btn-up text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_up</span></button>
                                        <button class="mobile-btn-down text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_down</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- PIPE SECTION 2: Retailer -> Customer (Hidden on mobile) -->
                <div class="hidden min-[780px]:flex flex-1 flex-col justify-between py-4 relative min-w-[100px] lg:min-w-[200px]">
                     <!-- Top Pipe: Deliveries (Rightward) -->
                     <div class="relative h-12 lg:h-16 top-[30px] lg:top-[40px] w-full flex items-center">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 mt-[2px] h-[30px] lg:h-[40px] bg-mono-surface rounded-none"></div>

                        <!-- Delay Boxes (Deliveries to Customer) -->
                        <div class="absolute w-full flex justify-center px-2 z-10 top-0 -mt-[3px] gap-2">
                            <!-- Week 1 -->
                             <div class="bg-mono-surface border border-accent/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center">W1</div>
                                <div id="outgoing-week-1" class="bg-accent/10 px-2 py-0.5 rounded border border-accent/20 text-accent font-sans font-bold text-center text-xs min-w-[30px]">25</div>
                            </div>
                            <!-- Week 2 -->
                             <div class="bg-mono-surface border border-accent/30 p-1 rounded shadow-lg">
                                <div class="text-[8px] text-mono-text uppercase text-center">W2</div>
                                <div id="outgoing-week-2" class="bg-accent/10 px-2 py-0.5 rounded border border-accent/20 text-accent font-sans font-bold text-center text-xs min-w-[30px]">20</div>
                            </div>
                       </div>
                    </div>

                    <!-- Bottom Pipe: Demand (Leftward) -->
                    <div class="relative h-12 lg:h-16 w-full flex items-center top-[5px]">
                         <!-- Pipe Background -->
                         <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[30px] lg:h-[40px] bg-mono-surface rounded-none"></div>
                    </div>
                </div>

                <!-- MOBILE VERTICAL CONNECTOR 2: Retailer -> Customer -->
                <div class="flex min-[780px]:hidden flex-row items-stretch justify-between w-full px-[calc(25%-51px)] -my-5">
                    <!-- Left pipe with W1/W2 boxes -->
                    <div class="flex flex-col items-center justify-evenly">
                        <!-- Vertical pipe line (top) - reaches role box -->
                        <div class="w-[46px] h-5 bg-mono-surface"></div>
                        <!-- W1 box -->
                        <div class="w-[52px] bg-mono-surface border border-accent/30 rounded p-1">
                            <div class="text-[8px] text-mono-text uppercase text-center">W1</div>
                            <div class="bg-accent/10 px-2 py-0.5 rounded border border-accent/20 text-accent font-sans font-bold text-center text-xs min-w-[30px]">25</div>
                        </div>
                        <!-- Pipe between W1 and W2 -->
                        <div class="w-[46px] flex-1 min-h-[8px] bg-mono-surface"></div>
                        <!-- W2 box -->
                        <div class="w-[52px] bg-mono-surface border border-accent/30 rounded p-1">
                            <div class="text-[8px] text-mono-text uppercase text-center">W2</div>
                            <div class="bg-accent/10 px-2 py-0.5 rounded border border-accent/20 text-accent font-sans font-bold text-center text-xs min-w-[30px]">20</div>
                        </div>
                        <!-- Vertical pipe line (bottom) - reaches role box -->
                        <div class="w-[46px] h-5 bg-mono-surface"></div>
                    </div>
                    <!-- Right pipe - continuous, no slots -->
                    <div class="w-[46px] self-stretch bg-mono-surface"></div>
                </div>

                <!-- 3. RIGHT NODE: CUSTOMERS -->
                <div class="w-full min-[780px]:w-40 lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-20">
                    <!-- Header - hidden on mobile -->
                    <div class="hidden min-[780px]:block p-3 lg:p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-xs lg:text-sm uppercase tracking-widest font-bold text-center">Customers</h3>
                    </div>

                    <!-- Mobile: Title (centered) + Demand slot (absolute right) in top row -->
                    <div class="min-[780px]:hidden relative p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Customers</h3>
                        <!-- Mobile Demand Box - aligned with right pipe -->
                        <div class="absolute top-3 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-red-500/30 p-1 rounded shadow-lg">
                            <div class="text-[8px] text-mono-text uppercase text-center mb-1">Demand</div>
                            <div class="mobile-customer-demand bg-red-500/10 px-2 py-1 rounded border border-red-500/20 text-red-400 font-sans font-bold text-center text-xs min-w-[40px] h-6">?</div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center p-3 min-[780px]:p-4 space-y-2 relative">
                        <!-- Stick Figures (Icons) -->
                        <div id="customer-icons" class="flex -space-x-2">
                            <span class="material-symbols-outlined text-3xl min-[780px]:text-4xl text-mono-light">person</span>
                            <span class="material-symbols-outlined text-3xl min-[780px]:text-4xl text-mono-light/80">person</span>
                            <span class="material-symbols-outlined text-3xl min-[780px]:text-4xl text-mono-light/60">person</span>
                        </div>
                        <span class="text-[10px] min-[780px]:text-xs text-mono-light">Market Demand</span>
                    </div>
                    <!-- Demand Box (Bottom) - tablet/desktop only -->
                    <div class="hidden min-[780px]:flex p-3 bg-mono-surface rounded-b-xl justify-start">
                        <div class="bg-mono-surface border border-red-500/30 p-1 rounded shadow-lg">
                            <div class="text-[8px] text-mono-text uppercase text-center mb-1">Demand</div>
                            <div id="customer-demand" class="bg-red-500/10 px-2 py-1 rounded border border-red-500/20 text-red-400 font-sans font-bold text-center text-xs min-w-[40px] h-6">?</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Animation Styles -->
            <style>
                @keyframes slideRight {
                    0% { transform: translateX(-100%); opacity: 0; }
                    50% { opacity: 1; }
                    100% { transform: translateX(100%); opacity: 0; }
                }
                @keyframes slideLeft {
                    0% { transform: translateX(100%); opacity: 0; }
                    50% { opacity: 1; }
                    100% { transform: translateX(-100%); opacity: 0; }
                }
                @keyframes extendLeft {
                    0% { width: 0; opacity: 0.5; }
                    100% { width: 100%; opacity: 0; }
                }
            </style>

            <!-- Charts Container -->
            <div id="charts-root" class="w-full flex-1 min-h-[320px] mt-8 mb-8"></div>
        </div>
    </div>

    <script type="text/babel">
        const { LineChart, Line, BarChart, Bar, ComposedChart, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } = Recharts;

        // Statistics Calculator Utility
        const StatisticsCalculator = {
            calculate(values) {
                if (!values || values.length === 0) return this.getEmptyStats();

                const n = values.length;
                const sorted = [...values].sort((a, b) => a - b);

                // Central tendency
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / n;
                const median = this.calculateMedian(sorted);
                const mode = this.calculateMode(values);

                // Dispersion
                const min = sorted[0];
                const max = sorted[n - 1];
                const range = max - min;
                const variance = n > 1 ? values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / (n - 1) : 0;
                const stdDev = Math.sqrt(variance);

                // Distribution shape
                const coeffVar = mean !== 0 ? (stdDev / Math.abs(mean)) * 100 : null;
                const skewness = this.calculateSkewness(values, mean, stdDev, n);
                const kurtosis = this.calculateKurtosis(values, mean, stdDev, n);
                const iqr = this.calculateIQR(sorted);

                // Inference (95% CI using CLT)
                const sem = n > 0 ? stdDev / Math.sqrt(n) : 0;
                const tCritical = this.getTCritical(n - 1);
                const marginError = tCritical * sem;
                const ci95Lower = mean - marginError;
                const ci95Upper = mean + marginError;

                return { n, min, max, mean, stdDev, coeffVar, mode, median, range, iqr, skewness, kurtosis, sem, marginError, ci95Lower, ci95Upper };
            },

            calculateMedian(sorted) {
                const n = sorted.length;
                const mid = Math.floor(n / 2);
                return n % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            },

            calculateMode(values) {
                const freq = {};
                values.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const maxFreq = Math.max(...Object.values(freq));
                if (maxFreq === 1) return 'None';
                const modes = Object.keys(freq).filter(k => freq[k] === maxFreq).map(Number);
                return modes.length === values.length ? 'None' : modes.join(', ');
            },

            calculateSkewness(values, mean, stdDev, n) {
                if (stdDev === 0 || n < 3) return null;
                const m3 = values.reduce((s, v) => s + Math.pow(v - mean, 3), 0) / n;
                const m2 = values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / n;
                return (m3 / Math.pow(m2, 1.5)) * Math.sqrt(n * (n - 1)) / (n - 2);
            },

            calculateKurtosis(values, mean, stdDev, n) {
                if (stdDev === 0 || n < 4) return null;
                const m4 = values.reduce((s, v) => s + Math.pow(v - mean, 4), 0) / n;
                const m2 = values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / n;
                const g2 = (m4 / Math.pow(m2, 2)) - 3;
                return ((n + 1) * g2 + 6) * (n - 1) / ((n - 2) * (n - 3));
            },

            calculateIQR(sorted) {
                const n = sorted.length;
                const q1 = sorted[Math.floor(n * 0.25)];
                const q3 = sorted[Math.floor(n * 0.75)];
                return q3 - q1;
            },

            getTCritical(df) {
                const tTable = {1:12.706,2:4.303,3:3.182,4:2.776,5:2.571,6:2.447,7:2.365,8:2.306,9:2.262,10:2.228,
                                11:2.201,12:2.179,13:2.160,14:2.145,15:2.131,20:2.086,25:2.060,29:2.045};
                if (df >= 30) return 1.96;
                return tTable[df] || tTable[Math.max(...Object.keys(tTable).map(Number).filter(k => k <= df))] || 2.0;
            },

            getEmptyStats() {
                return { n:0, min:'-', max:'-', mean:'-', stdDev:'-', coeffVar:'-', mode:'-', median:'-',
                         range:'-', iqr:'-', skewness:'-', kurtosis:'-', sem:'-', marginError:'-', ci95Lower:'-', ci95Upper:'-' };
            }
        };

        // Cost rates
        const HOLDING_COST_RATE = 10;   // $ per unit of inventory per week
        const BACKORDER_COST_RATE = 20; // $ per unit of backorder per week

        // Initial conditions
        const INITIAL_INVENTORY = 50;

        // External inputs: demand (from customers) and deliveries (from wholesaler)
        const weeklyInputs = [
            { week: '1', demand: 10, deliveries: 0 },
            { week: '2', demand: 12, deliveries: 10 },
            { week: '3', demand: 15, deliveries: 10 },
            { week: '4', demand: 25, deliveries: 12 },
            { week: '5', demand: 40, deliveries: 15 },
            { week: '6', demand: 35, deliveries: 20 },
            { week: '7', demand: 30, deliveries: 25 },
            { week: '8', demand: 20, deliveries: 30 },
            { week: '9', demand: 15, deliveries: 25 },
            { week: '10', demand: 12, deliveries: 20 },
        ];

        // Simulate the game: compute inventory, backorders, outgoing orders
        let inventory = INITIAL_INVENTORY;
        let backorders = 0;
        let cumHolding = 0;
        let cumBackorder = 0;

        const data = weeklyInputs.map(input => {
            // Available stock = current inventory + incoming deliveries
            const available = inventory + input.deliveries;

            // Total demand = new demand + any backorders from previous weeks
            const totalDemand = input.demand + backorders;

            // Outgoing orders (what we actually ship) = min(available, totalDemand)
            const outgoingOrders = Math.min(available, totalDemand);

            // New inventory = max(0, available - totalDemand)
            const newInventory = Math.max(0, available - totalDemand);

            // New backorders = max(0, totalDemand - available)
            const newBackorders = Math.max(0, totalDemand - available);

            // Costs based on END-of-period inventory/backorders
            const holdingCost = newInventory * HOLDING_COST_RATE;
            const backorderCost = newBackorders * BACKORDER_COST_RATE;
            cumHolding += holdingCost;
            cumBackorder += backorderCost;

            const row = {
                week: input.week,
                incomingOrders: input.demand,      // Demand from customers
                deliveries: input.deliveries,      // Deliveries from wholesaler
                outgoingOrders,                    // What we ship = min(available, demand)
                inventory: newInventory,           // End-of-period inventory
                backorders: newBackorders,         // End-of-period backorders
                holdingCost,
                backorderCost,
                cumHoldingCost: cumHolding,
                cumBackorderCost: cumBackorder,
                totalCost: cumHolding + cumBackorder
            };

            // Update state for next week
            inventory = newInventory;
            backorders = newBackorders;

            return row;
        });

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-mono-surface border border-mono-light/20 p-3 rounded shadow-xl">
                        <p className="text-mono-text font-bold mb-1">{label}</p>
                        {payload.map((entry, index) => (
                            <p key={index} style={{ color: entry.color }} className="text-sm">
                                {entry.name}: {entry.value}
                            </p>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // StatItem - individual stat display
        const StatItem = ({ label, value }) => (
            <div className="flex justify-between items-center">
                <span className="text-xs text-mono-light">{label}</span>
                <span className="font-mono text-sm font-medium text-mono-text">{value}</span>
            </div>
        );

        // StatGroup - grouped statistics with header
        const StatGroup = ({ title, children }) => (
            <div className="bg-mono-bg/30 rounded-xl p-3 border border-mono-light/10">
                <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">{title}</h4>
                <div className="space-y-1.5">{children}</div>
            </div>
        );

        // Metrics configuration
        const METRICS = [
            { id: 'inventory', label: 'Inventory' },
            { id: 'backorders', label: 'Backorders' },
            { id: 'incomingOrders', label: 'Incoming' },
            { id: 'outgoingOrders', label: 'Outgoing' },
            { id: 'holdingCost', label: 'Hold $' },
            { id: 'backorderCost', label: 'Back $' },
            { id: 'totalCost', label: 'Total $' },
        ];

        // StatisticsPanel - main statistics component with tabs
        const StatisticsPanel = ({ gameData }) => {
            const [activeMetric, setActiveMetric] = React.useState('inventory');
            const tabsRef = React.useRef(null);

            const metricValues = React.useMemo(() =>
                gameData.map(week => week[activeMetric] ?? 0), [gameData, activeMetric]);

            const stats = React.useMemo(() =>
                StatisticsCalculator.calculate(metricValues), [metricValues]);

            const fmt = (v, d = 2) => {
                if (v === '-' || v === 'None' || v === null) return v ?? '-';
                return typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(d)) : v;
            };

            const scrollTabs = (direction) => {
                const container = tabsRef.current;
                if (!container) return;
                const scrollAmount = 80;
                const newPos = direction === 'left'
                    ? Math.max(0, container.scrollLeft - scrollAmount)
                    : container.scrollLeft + scrollAmount;
                container.scrollTo({ left: newPos, behavior: 'smooth' });
            };

            return (
                <div className="flex flex-col w-full">
                    {/* Header with title and sample size */}
                    <div className="flex items-center justify-between mb-3 flex-shrink-0 gap-2">
                        <h3 className="font-semibold text-mono-text text-sm sm:text-base truncate">Statistics</h3>
                        <span className="text-[10px] text-mono-light uppercase tracking-wider whitespace-nowrap">n={gameData.length}</span>
                    </div>

                    {/* Metric Tabs - Single Row with Arrow Navigation */}
                    <div className="flex items-center gap-1 mb-4 pb-2 border-b border-mono-light/10 overflow-hidden flex-shrink-0">
                        <button onClick={() => scrollTabs('left')} className="p-0.5 text-mono-light hover:text-mono-text hover:bg-mono-bg/30 rounded transition-all flex-shrink-0">
                            <span className="material-symbols-outlined text-base">chevron_left</span>
                        </button>
                        <div ref={tabsRef} className="flex gap-1 overflow-x-scroll flex-1 min-w-0" style={{scrollbarWidth: 'none', msOverflowStyle: 'none', scrollBehavior: 'smooth'}}>
                            {METRICS.map(m => (
                                <button key={m.id} onClick={() => setActiveMetric(m.id)}
                                    className={`px-2 py-1 text-xs font-medium rounded transition-all whitespace-nowrap flex-shrink-0
                                        ${activeMetric === m.id
                                            ? 'bg-accent/20 text-accent border-b-2 border-accent'
                                            : 'text-mono-light hover:text-mono-text hover:bg-mono-bg/30'}`}>
                                    {m.label}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => scrollTabs('right')} className="p-0.5 text-mono-light hover:text-mono-text hover:bg-mono-bg/30 rounded transition-all flex-shrink-0">
                            <span className="material-symbols-outlined text-base">chevron_right</span>
                        </button>
                    </div>

                    {/* Statistics Grid - Single Column */}
                    <div className="grid grid-cols-1 gap-3">
                        <StatGroup title="Central Tendency">
                            <StatItem label="Mean" value={fmt(stats.mean)} />
                            <StatItem label="Median" value={fmt(stats.median)} />
                            <StatItem label="Mode" value={stats.mode} />
                        </StatGroup>

                        <StatGroup title="Dispersion">
                            <StatItem label="Min" value={fmt(stats.min, 0)} />
                            <StatItem label="Max" value={fmt(stats.max, 0)} />
                            <StatItem label="Range" value={fmt(stats.range, 0)} />
                            <StatItem label="Std Dev" value={fmt(stats.stdDev)} />
                        </StatGroup>

                        <StatGroup title="Distribution">
                            <StatItem label="CV" value={stats.coeffVar !== null ? `${fmt(stats.coeffVar)}%` : '-'} />
                            <StatItem label="Skewness" value={fmt(stats.skewness)} />
                            <StatItem label="Kurtosis" value={fmt(stats.kurtosis)} />
                            <StatItem label="IQR" value={fmt(stats.iqr)} />
                        </StatGroup>

                        <StatGroup title="Inference (95% CI)">
                            <StatItem label="Std Error" value={fmt(stats.sem)} />
                            <StatItem label="Margin" value={fmt(stats.marginError)} />
                            <StatItem label="CI Lower" value={fmt(stats.ci95Lower)} />
                            <StatItem label="CI Upper" value={fmt(stats.ci95Upper)} />
                        </StatGroup>
                    </div>
                </div>
            );
        };

        // MetricsPanel - KPI component showing key performance indicators
        const MetricsPanel = ({ gameData }) => {
            // Calculate metrics
            const metrics = React.useMemo(() => {
                if (!gameData || gameData.length === 0) return { totalCost: 0, serviceLevel: 0, fillRate: 0 };

                // Total Cost: final cumulative cost
                const totalCost = gameData[gameData.length - 1].totalCost;

                // Service Level: ratio of fully delivered orders to total orders
                // A fully delivered order is when outgoingOrders >= incomingOrders (demand)
                const fullyDeliveredOrders = gameData.filter(w => w.outgoingOrders >= w.incomingOrders).length;
                const serviceLevel = (fullyDeliveredOrders / gameData.length) * 100;

                // Fill Rate: ratio of total delivered to total demanded
                const totalDelivered = gameData.reduce((sum, w) => sum + w.outgoingOrders, 0);
                const totalDemanded = gameData.reduce((sum, w) => sum + w.incomingOrders, 0);
                const fillRate = totalDemanded > 0 ? (totalDelivered / totalDemanded) * 100 : 0;

                return { totalCost, serviceLevel, fillRate };
            }, [gameData]);

            return (
                <div className="flex flex-col h-full">
                    <h3 className="font-semibold mb-3 text-mono-text">Metrics</h3>

                    <div className="flex flex-col gap-4 flex-1">
                        {/* Total Cost */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Total Cost</h4>
                            <div className="text-3xl font-bold text-accent">${metrics.totalCost.toLocaleString()}</div>
                            <p className="text-[10px] text-mono-light mt-1">Cumulative holding + backorder costs</p>
                        </div>

                        {/* Service Level */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Service Level</h4>
                            <div className="text-3xl font-bold" style={{color: metrics.serviceLevel >= 80 ? '#4ade80' : metrics.serviceLevel >= 50 ? '#FFCC66' : '#f87171'}}>
                                {metrics.serviceLevel.toFixed(1)}%
                            </div>
                            <p className="text-[10px] text-mono-light mt-1">Fully delivered orders / total orders</p>
                        </div>

                        {/* Fill Rate */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Fill Rate</h4>
                            <div className="text-3xl font-bold" style={{color: metrics.fillRate >= 90 ? '#4ade80' : metrics.fillRate >= 70 ? '#FFCC66' : '#f87171'}}>
                                {metrics.fillRate.toFixed(1)}%
                            </div>
                            <p className="text-[10px] text-mono-light mt-1">Delivered quantity / ordered quantity</p>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardCharts = () => {
            // Orders vs Inventory chart toggles
            const [showOrders, setShowOrders] = React.useState(true);
            const [showInventory, setShowInventory] = React.useState(true);
            const [showBackorders, setShowBackorders] = React.useState(true);
            // Cost chart toggles
            const [showHoldingCost, setShowHoldingCost] = React.useState(true);
            const [showBackorderCost, setShowBackorderCost] = React.useState(true);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full h-full">
                    {/* LEFT COLUMN - Charts stacked vertically */}
                    <div className="flex flex-col gap-6">
                        {/* Orders vs Inventory Chart */}
                        <div className="bg-mono-surface p-2 sm:p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1">
                            {/* Header with title and toggles */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 sm:mb-4">
                                <h3 className="font-semibold text-mono-text text-sm sm:text-base">Orders vs. Inventory</h3>
                                <div className="flex items-center gap-2 sm:gap-3">
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showInventory}
                                            onChange={(e) => setShowInventory(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/50 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs" style={{color: '#FFCC66'}}>Inventory</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showBackorders}
                                            onChange={(e) => setShowBackorders(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/90 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/90">Backorders</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer sm:ml-auto">
                                        <input
                                            type="checkbox"
                                            checked={showOrders}
                                            onChange={(e) => setShowOrders(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/10 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/30">Orders</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex-1 w-full min-h-[180px] sm:min-h-[200px] bg-accent/5 border border-accent/10 rounded-lg overflow-hidden">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={data} margin={{ top: 20, right: 15, left: 5, bottom: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#404040" vertical={false} />
                                        <XAxis dataKey="week" stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Week', position: 'bottom', offset: 0, fill: '#808080', fontSize: 10 }} />
                                        <YAxis stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Units', position: 'insideTopLeft', fill: '#808080', fontSize: 10, dy: -15 }} />
                                        <Tooltip content={<CustomTooltip />} />
                                        {showOrders && <Bar dataKey="outgoingOrders" name="Orders" fill="rgba(255, 215, 0, 0.1)" barSize={12} radius={[2, 2, 0, 0]} />}
                                        {showInventory && <Line type="monotone" dataKey="inventory" name="Inventory" stroke="#FFCC66" strokeWidth={3} dot={{r: 3, fill: '#FFCC66'}} activeDot={{r: 6}} />}
                                        {showBackorders && <Line type="monotone" dataKey="backorders" name="Backorders" stroke="rgba(255, 215, 0, 0.9)" strokeWidth={2} dot={{r: 3, fill: 'rgba(255, 215, 0, 0.9)'}} activeDot={{r: 5}} />}
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* Cost Accumulation Chart - Stacked */}
                        <div className="bg-mono-surface p-2 sm:p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1">
                            {/* Header with title and toggles */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 sm:mb-4">
                                <h3 className="font-semibold text-mono-text text-sm sm:text-base">Cost Accumulation</h3>
                                <div className="flex items-center gap-2 sm:gap-4">
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showHoldingCost}
                                            onChange={(e) => setShowHoldingCost(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/50 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs" style={{color: '#FFCC66'}}>Holding</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showBackorderCost}
                                            onChange={(e) => setShowBackorderCost(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/90 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/90">Backorder</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex-1 w-full min-h-[180px] sm:min-h-[200px] bg-accent/5 border border-accent/10 rounded-lg overflow-hidden">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={data} margin={{ top: 5, right: 15, left: 5, bottom: 20 }}>
                                        <defs>
                                            <linearGradient id="colorHoldingCost" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#FFCC66" stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor="#FFCC66" stopOpacity={0.2}/>
                                            </linearGradient>
                                            <linearGradient id="colorBackorderCost" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="rgba(255, 215, 0, 0.9)" stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor="rgba(255, 215, 0, 0.9)" stopOpacity={0.2}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#404040" vertical={false} />
                                        <XAxis dataKey="week" stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Week', position: 'bottom', offset: 0, fill: '#808080', fontSize: 10 }} />
                                        <YAxis stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Cost ($)', angle: -90, position: 'insideLeft', fill: '#808080', fontSize: 10, dx: -5 }} />
                                        <Tooltip content={<CustomTooltip />} />
                                        {showHoldingCost && <Area type="monotone" dataKey="cumHoldingCost" name="Holding Cost ($)" stackId="1" stroke="#FFCC66" fillOpacity={1} fill="url(#colorHoldingCost)" />}
                                        {showBackorderCost && <Area type="monotone" dataKey="cumBackorderCost" name="Backorder Cost ($)" stackId="1" stroke="rgba(255, 215, 0, 0.9)" fillOpacity={1} fill="url(#colorBackorderCost)" />}
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT COLUMN - Metrics and Statistics Panels side-by-side */}
                    <div className="flex flex-col md:flex-row gap-4">
                        {/* Metrics Panel - Half Width */}
                        <div className="bg-mono-surface p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1 min-w-0 overflow-hidden">
                            <MetricsPanel gameData={data} />
                        </div>
                        {/* Statistics Panel - Half Width */}
                        <div className="bg-mono-surface p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1 min-w-0">
                            <StatisticsPanel gameData={data} />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('charts-root'));
        root.render(<DashboardCharts />);
    </script>
</body></html>