<!DOCTYPE html>
<html class="" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Beer Game - Distributor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

<!-- React & Recharts Dependencies -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
<script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        'mono-bg': '#1A1A1A', // Dark charcoal/black background
                        'mono-surface': '#2C2C2C', // Slightly lighter dark gray for cards/surfaces
                        'mono-text': '#E0E0E0', // Light gray for primary text
                        'mono-light': '#808080', // Medium gray for secondary text/borders
                        'accent': '#8B5CF6', // Purple as the contrasting accent color
                    },
                    fontFamily: {
                        sans: ["Inter", "system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "sans-serif"],
                        mono: ["Roboto Mono", "monospace"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem", // Sharper corners for a modern look
                        'sm': "0.125rem",
                        'md': "0.375rem",
                        'lg': "0.5rem",
                        'xl': "0.75rem",
                        'full': "9999px",
                    },
                    borderWidth: {
                        '1': '1px',
                    }
                },
            },
        };
    </script>
<style type="text/tailwindcss">body {
            @apply font-sans bg-mono-bg text-mono-text antialiased;
        }.flow-pipe {
            @apply absolute bg-mono-light opacity-50 transition-all duration-300 ease-out;
        }
        .flow-pipe.active {
            @apply bg-accent opacity-100;
        }
        .flow-pipe.vertical {
            @apply w-[2px] h-1/2;
        }
        .flow-pipe.horizontal {
            @apply h-[2px] w-1/2;
        }
        .flow-pipe.arrow-end::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            @apply opacity-0 transition-opacity duration-300 ease-out;
        }
        .flow-pipe.arrow-end.active::after {
             @apply opacity-100;
        }
        .flow-pipe.arrow-down::after {
            border-width: 6px 4px 0 4px;border-color: var(--tw-bg-accent) transparent transparent transparent;
            left: 50%;
            bottom: -6px;transform: translateX(-50%);
        }
        .flow-pipe.arrow-up::after {
            border-width: 0 4px 6px 4px;border-color: transparent transparent var(--tw-bg-accent) transparent;
            left: 50%;
            top: -6px;transform: translateX(-50%);
        }
        .flow-pipe.arrow-right::after {
            border-width: 4px 0 4px 6px;border-color: transparent transparent transparent var(--tw-bg-accent);
            top: 50%;
            right: -6px;transform: translateY(-50%);
        }
        .flow-pipe.arrow-left::after {
            border-width: 4px 6px 4px 0;border-color: transparent var(--tw-bg-accent) transparent transparent;
            top: 50%;
            left: -6px;transform: translateY(-50%);
        }
        /* Hide numeric spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="font-sans bg-mono-bg text-mono-text antialiased">
    <div class="w-full h-screen p-6 overflow-auto">
        <div class="flex-1 flex flex-col w-full max-w-[1600px] mx-auto relative z-10 space-y-6 px-6">
            
            <!-- MAIN GAME BOARD (Sketch Implementation) -->
            <div class="w-full bg-mono-surface/40 backdrop-blur-md border border-mono-light/10 rounded-2xl p-4 lg:p-6 lg:p-8 shadow-2xl flex flex-col-reverse lg:flex-row items-stretch lg:justify-between gap-4 lg:gap-0 relative overflow-hidden">
                
                <!-- 1. LEFT NODE: FACTORY -->
                <div class="w-full lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-20 group">
                    <!-- Header - hidden on mobile -->
                    <div class="hidden lg:block p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-sm uppercase tracking-widest font-bold text-center">Factory</h3>
                    </div>

                    <!-- Mobile: Title (centered) in top row -->
                    <div class="lg:hidden p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Factory</h3>
                    </div>

                    <div class="flex-1 flex items-center justify-start pt-2 lg:pt-[34px] p-3 lg:p-4 relative flex-col">
                         <!-- Mobile Order Box - aligned with right pipe, centered with inventory -->
                        <div class="lg:hidden absolute top-1/2 -translate-y-1/2 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg z-10">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div class="mobile-factory-order bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">&nbsp;</div>
                        </div>

                         <!-- Faint background icon -->
                         <span class="material-symbols-outlined text-7xl lg:text-9xl text-mono-light/5 absolute opacity-[0.03] top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">factory</span>
                         
                         <!-- Hidden Inventory Box (Factory) -->
                         <div id="factory-inventory" class="bg-mono-bg/30 p-4 mt-0 lg:mt-[15px] rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] lg:min-w-[120px] min-h-[80px] lg:min-h-[100px] relative z-10 cursor-help" title="Hidden Information">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-3xl lg:text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">&nbsp;</div>
                        </div>
                    </div>
                    <!-- Incoming Order Box (Bottom) - tablet/desktop only -->
                    <div class="hidden lg:flex p-4 bg-mono-surface rounded-b-xl flex justify-end">
                         <div class="bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div id="factory-order-value" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">&nbsp;</div>
                        </div>
                    </div>
                </div>

                <!-- PIPE SECTION 1: Factory -> Distributor (Hidden on mobile) -->
                <div class="hidden lg:flex flex-1 flex-col justify-between py-4 relative min-w-[200px]">
                    
                    <!-- Top Pipe: Deliveries (Rightward) -->
                    <div class="relative h-16 top-[40px] w-full flex items-center">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 mt-[2px] h-[40px] bg-mono-surface rounded-none"></div>

                        <!-- Delay Boxes (Sitting on pipe) - ORANGE for Factory -->
                        <div class="absolute w-full flex justify-evenly px-4 z-10 top-0 -mt-[11px]">
                             <!-- Week 1 -->
                             <div class="bg-mono-surface border border-orange-500/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                                <div id="delivery-week-1" class="bg-orange-500/10 px-3 py-1 rounded border border-orange-500/20 text-orange-400 font-sans font-bold text-center min-w-[55px]">20</div>
                            </div>
                             <!-- Week 2 -->
                             <div class="bg-mono-surface border border-orange-500/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                                <div id="delivery-week-2" class="bg-orange-500/10 px-3 py-1 rounded border border-orange-500/20 text-orange-400 font-sans font-bold text-center min-w-[55px]">30</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Pipe: Orders (Leftward) -->
                    <div class="relative h-16 w-full flex items-center top-[5px]">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[40px] bg-mono-surface rounded-none"></div>
                    </div>
                </div>

                <!-- MOBILE VERTICAL CONNECTOR 1: Factory -> Distributor -->
                <div class="flex lg:hidden flex-row items-stretch justify-between w-full px-[calc(25%-60px)] -my-5">
                    <!-- Left pipe with Week 1/Week 2 boxes (deliveries flowing down) - ORANGE -->
                    <div class="flex flex-col items-center justify-evenly">
                        <!-- Vertical pipe line (top) - reaches role box -->
                        <div class="w-[70px] h-8 bg-mono-surface"></div>
                        <!-- Week 2 box -->
                        <div id="mobile-delivery-week-2-box" class="bg-mono-surface border border-orange-500/30 rounded p-2">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                            <div id="mobile-delivery-week-2" class="bg-orange-500/10 px-3 py-1 rounded border border-orange-500/20 text-orange-400 font-sans font-bold text-center min-w-[55px]">30</div>
                        </div>
                        <!-- Pipe between Week 2 and Week 1 -->
                        <div class="w-[70px] flex-1 min-h-[16px] bg-mono-surface"></div>
                        <!-- Week 1 box -->
                        <div id="mobile-delivery-week-1-box" class="bg-mono-surface border border-orange-500/30 rounded p-2">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                            <div id="mobile-delivery-week-1" class="bg-orange-500/10 px-3 py-1 rounded border border-orange-500/20 text-orange-400 font-sans font-bold text-center min-w-[55px]">20</div>
                        </div>
                        <!-- Vertical pipe line (bottom) - reaches role box -->
                        <div class="w-[70px] h-8 bg-mono-surface"></div>
                    </div>
                    <!-- Right pipe - continuous (orders flowing up) -->
                    <div id="mobile-order-pipe-1" class="w-[70px] self-stretch bg-mono-surface"></div>
                </div>

                <!-- 2. CENTER NODE: INVENTORY (DISTRIBUTOR) -->
                <div class="w-full lg:w-56 min-h-[250px] lg:min-h-0 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-30">
                    
                    <!-- Mobile: Absolutely centered Inventory (pushed down to avoid overlap with Order) -->
                    <div id="distributor-inventory-mobile" class="lg:hidden absolute left-1/2 top-[55%] -translate-x-1/2 -translate-y-1/2 bg-mono-bg/30 p-2 rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] min-h-[120px] z-20">
                        <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-10">Inventory</h4>
                        <div class="text-3xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">50</div>
                    </div>

                    <!-- Header - hidden on mobile -->
                    <div class="hidden lg:block p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-sm uppercase tracking-widest font-bold text-center">Distributor</h3>
                    </div>

                    <!-- Mobile: Title (centered) + Order slot at top right -->
                    <div class="lg:hidden p-3 pb-0 relative">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Distributor</h3>
                        <!-- Mobile Order Box - aligned with right pipe at top (incoming orders from Wholesaler) -->
                        <div class="absolute top-3 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg z-10">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div class="mobile-distributor-order-received bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">&nbsp;</div>
                        </div>
                    </div>

                    <!-- Inventory Display (Wrapped Box) - Desktop only -->
                    <div class="hidden lg:flex flex-1 items-center justify-center pt-[34px] p-6">
                         <div id="distributor-inventory" class="bg-mono-bg/30 p-4 mt-[15px] rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[120px] min-h-[100px]">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">50</div>
                        </div>
                    </div>
                    <!-- Mobile: Spacer to maintain layout -->
                    <div class="lg:hidden flex-1"></div>

                    <!-- Bottom Section: Order (Left) & Demand (Right) - Hidden on mobile -->
                    <div class="hidden lg:flex p-4 bg-mono-surface rounded-b-xl flex justify-between items-end gap-2 relative">
                        
                        <!-- Order Section with Send Button -->
                        <div class="flex flex-col items-center gap-2">
                            <button id="btnSend" class="w-full bg-transparent border border-accent hover:bg-accent/10 text-white rounded py-1 shadow-md transition-colors flex items-center justify-center">
                                <span class="text-[10px] font-bold uppercase">Send</span>
                            </button>
                        
                            <!-- Order Input (Numeric Up/Down - Styled like Wholesaler) -->
                             <div class="bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform relative group">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div id="distributor-order-value" class="bg-accent/10 px-1 py-0 rounded border border-accent/20 flex items-center justify-center min-w-[55px]">
                                    <input type="number" value="30" id="orderInput" min="0" class="w-6 bg-transparent text-center font-sans font-bold text-accent text-xs border-0 p-0 focus:ring-0 appearance-none" />
                                    <div class="flex flex-col ml-0.5">
                                        <button id="btnUp" class="text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_up</span></button>
                                        <button id="btnDown" class="text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_down</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Order Received Box (Right, Dashed) - from Wholesaler (green/accent for them, but here accent is purple?) -->
                        <!-- Wait, incoming orders are from Wholesaler. Wholesaler color is GREEN (#10B981). -->
                        <!-- So this box should be GREEN to match incoming signal source -->
                         <div id="distributor-order-received" class="bg-mono-surface border border-dashed border-emerald-500/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform cursor-pointer">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div id="distributor-order-received-value" class="bg-emerald-500/10 px-3 py-1 rounded border border-emerald-500/20 text-emerald-400 font-sans font-bold text-center min-w-[55px]">&nbsp;</div>
                        </div>
                    </div>

                    <!-- Mobile: Order Box at bottom - aligned with right pipe -->
                    <div class="lg:hidden p-4 pt-0 bg-mono-surface rounded-b-xl flex justify-end pr-[calc(25%-28px)]">
                        <div class="flex flex-col items-center gap-2 translate-x-1/2">
                            <button class="mobile-btn-send w-full bg-transparent border border-accent hover:bg-accent/10 text-white rounded py-1 shadow-md transition-colors flex items-center justify-center">
                                <span class="text-[10px] font-bold uppercase">Send</span>
                            </button>
                            <div class="bg-mono-surface border border-dashed border-accent/30 p-2 rounded shadow-lg">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                                <div class="bg-accent/10 px-3 py-1 rounded border border-accent/20 flex items-center justify-center min-w-[55px]">
                                    <input type="number" value="30" min="0" class="mobile-order-input w-6 bg-transparent text-center font-sans font-bold text-accent border-0 p-0 focus:ring-0 appearance-none" />
                                    <div class="flex flex-col ml-0.5">
                                        <button class="mobile-btn-up text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_up</span></button>
                                        <button class="mobile-btn-down text-accent hover:text-white leading-none"><span class="material-symbols-outlined text-[10px]">arrow_drop_down</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- PIPE SECTION 2: Distributor -> Wholesaler (Hidden on mobile) -->
                <div class="hidden lg:flex flex-1 flex-col justify-between py-4 relative min-w-[200px]">
                     <!-- Top Pipe: Deliveries (Rightward) - PURPLE/ACCENT -->
                     <div class="relative h-16 top-[40px] w-full flex items-center">
                        <!-- Pipe Background -->
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 mt-[2px] h-[40px] bg-mono-surface rounded-none"></div>

                        <!-- Delay Boxes (Deliveries to Wholesaler) - PURPLE/ACCENT -->
                        <div class="absolute w-full flex justify-evenly px-4 z-10 top-0 -mt-[11px]">
                            <!-- Week 1 -->
                             <div class="bg-mono-surface border border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                                <div id="outgoing-week-1" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">25</div>
                            </div>
                            <!-- Week 2 -->
                             <div class="bg-mono-surface border border-accent/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                                <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                                <div id="outgoing-week-2" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">20</div>
                            </div>
                       </div>
                    </div>

                    <!-- Bottom Pipe: Orders (Leftward) -->
                    <div class="relative h-16 w-full flex items-center top-[5px]">
                         <!-- Pipe Background -->
                         <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[40px] bg-mono-surface rounded-none"></div>
                    </div>
                </div>

                <!-- MOBILE VERTICAL CONNECTOR 2: Distributor -> Wholesaler -->
                <div class="flex lg:hidden flex-row items-stretch justify-between w-full px-[calc(25%-60px)] -my-5">
                    <!-- Left pipe with Week 1/Week 2 boxes (outgoing deliveries flowing down) - PURPLE/ACCENT -->
                    <div class="flex flex-col items-center justify-evenly">
                        <!-- Vertical pipe line (top) - reaches role box -->
                        <div class="w-[70px] h-8 bg-mono-surface"></div>
                        <!-- Week 2 box -->
                        <div id="mobile-outgoing-week-2-box" class="bg-mono-surface border border-accent/30 rounded p-2">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 2</div>
                            <div id="mobile-outgoing-week-2" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">20</div>
                        </div>
                        <!-- Pipe between Week 2 and Week 1 -->
                        <div class="w-[70px] flex-1 min-h-[16px] bg-mono-surface"></div>
                        <!-- Week 1 box -->
                        <div id="mobile-outgoing-week-1-box" class="bg-mono-surface border border-accent/30 rounded p-2">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Week 1</div>
                            <div id="mobile-outgoing-week-1" class="bg-accent/10 px-3 py-1 rounded border border-accent/20 text-accent font-sans font-bold text-center min-w-[55px]">25</div>
                        </div>
                        <!-- Vertical pipe line (bottom) - reaches role box -->
                        <div class="w-[70px] h-8 bg-mono-surface"></div>
                    </div>
                    <!-- Right pipe - continuous (orders flowing up) -->
                    <div id="mobile-order-pipe" class="w-[70px] self-stretch bg-mono-surface"></div>
                </div>

                <!-- 3. RIGHT NODE: WHOLESALER -->
                <div class="w-full lg:w-56 bg-mono-surface border border-mono-surface rounded-xl flex flex-col shadow-xl relative z-20">
                    <!-- Header - hidden on mobile -->
                    <div class="hidden lg:block p-4 border-b border-mono-light/10 bg-mono-bg/30 rounded-t-xl">
                        <h3 class="text-mono-text text-sm uppercase tracking-widest font-bold text-center">Wholesaler</h3>
                    </div>

                    <!-- Mobile: Title (centered) in top row -->
                    <div class="lg:hidden p-3 pb-0">
                        <h3 class="text-mono-text text-xs uppercase tracking-widest font-bold text-center">Wholesaler</h3>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center p-3 lg:p-4 space-y-2 relative">
                        <!-- Mobile Order Box - aligned with right pipe, centered with inventory -->
                        <div class="lg:hidden absolute top-1/2 -translate-y-1/2 right-[calc(25%-28px)] translate-x-1/2 bg-mono-surface border border-amber-400/30 p-2 rounded shadow-lg z-10">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div class="mobile-wholesaler-order bg-amber-400/10 px-3 py-1 rounded border border-amber-400/20 text-amber-400 font-sans font-bold text-center min-w-[55px]">?</div>
                        </div>
                        <!-- Hidden Inventory Box (Wholesaler - downstream) -->
                        <div id="wholesaler-inventory-downstream" class="bg-mono-bg/30 p-4 rounded-lg shadow-inner flex flex-col items-center justify-center min-w-[100px] lg:min-w-[120px] min-h-[80px] lg:min-h-[100px] cursor-help" title="Hidden Information">
                            <h4 class="text-mono-text text-[10px] uppercase tracking-widest mb-1">Inventory</h4>
                            <div class="text-3xl lg:text-5xl font-sans font-bold text-white tracking-tighter drop-shadow-lg">&nbsp;</div>
                        </div>
                    </div>
                    <!-- Order Box (Bottom) - tablet/desktop only - AMBER -->
                    <div class="hidden lg:flex p-4 bg-mono-surface rounded-b-xl justify-start">
                        <div class="bg-mono-surface border border-amber-400/30 p-2 rounded shadow-lg transform hover:scale-110 transition-transform">
                            <div class="text-[10px] text-mono-text uppercase text-center mb-1">Order</div>
                            <div id="wholesaler-order-downstream" class="bg-amber-400/10 px-3 py-1 rounded border border-amber-400/20 text-amber-400 font-sans font-bold text-center min-w-[55px]">?</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Animation Styles -->
            <style>
                @keyframes slideRight {
                    0% { transform: translateX(-100%); opacity: 0; }
                    50% { opacity: 1; }
                    100% { transform: translateX(100%); opacity: 0; }
                }
                @keyframes slideLeft {
                    0% { transform: translateX(100%); opacity: 0; }
                    50% { opacity: 1; }
                    100% { transform: translateX(-100%); opacity: 0; }
                }
                @keyframes extendLeft {
                    0% { width: 0; opacity: 0.5; }
                    100% { width: 100%; opacity: 0; }
                }
            </style>

            <!-- Charts Container -->
            <div id="charts-root" class="w-full flex-1 min-h-[320px] mt-8 mb-8"></div>
        </div>
    </div>

    <script type="text/babel">
        const { LineChart, Line, BarChart, Bar, ComposedChart, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } = Recharts;

        // ==========================================
        // GAME LOGIC & ANIMATION SECTION
        // ==========================================
        const initGameLogic = () => {
            // Desktop elements
            const orderInput = document.getElementById('orderInput');
            const btnUp = document.getElementById('btnUp');
            const btnDown = document.getElementById('btnDown');
            const btnSend = document.getElementById('btnSend');

            // Mobile elements
            const mobileOrderInput = document.querySelector('.mobile-order-input');
            const mobileBtnUp = document.querySelector('.mobile-btn-up');
            const mobileBtnDown = document.querySelector('.mobile-btn-down');
            const mobileBtnSend = document.querySelector('.mobile-btn-send');
            
            // Mobile specialized elements
            const mobileDistributorOrderReceived = document.querySelector('.mobile-distributor-order-received');
            const mobileFactoryOrder = document.querySelector('.mobile-factory-order');
            const mobileWholesalerOrder = document.querySelector('.mobile-wholesaler-order'); // This might be the source of orders?

            // --- Get Elements by ID ---
            const els = {
                // Desktop IDs
                factoryOrderInner: document.getElementById('factory-order-value'),
                distributorOrderInner: document.getElementById('distributor-order-value'),
                distributorInventory: document.getElementById('distributor-inventory'),
                
                // Left Pipe (Factory -> Distributor) - ORANGE
                orangeWeek1: document.getElementById('delivery-week-1'),
                orangeWeek2: document.getElementById('delivery-week-2'),
                
                // Right Pipe (Distributor -> Wholesaler) - PURPLE
                purpleWeek1: document.getElementById('outgoing-week-1'),
                purpleWeek2: document.getElementById('outgoing-week-2'),
                
                // Incoming Orders (from Wholesaler)
                distributorOrderReceived: document.getElementById('distributor-order-received'),
                distributorOrderReceivedInner: document.getElementById('distributor-order-received-value'),
                
                // Downstream Node (Wholesaler)
                wholesalerOrder: document.getElementById('wholesaler-order-downstream'),
                wholesalerInventory: document.getElementById('wholesaler-inventory-downstream'),

                // Mobile Elements
                mobileDeliveryWeek1: document.getElementById('mobile-delivery-week-1'), // Orange
                mobileDeliveryWeek2: document.getElementById('mobile-delivery-week-2'), // Orange
                mobileDeliveryWeek1Box: document.getElementById('mobile-delivery-week-1-box'),
                mobileDeliveryWeek2Box: document.getElementById('mobile-delivery-week-2-box'),
                
                mobileOutgoingWeek1: document.getElementById('mobile-outgoing-week-1'), // Purple
                mobileOutgoingWeek2: document.getElementById('mobile-outgoing-week-2'), // Purple
                mobileOutgoingWeek1Box: document.getElementById('mobile-outgoing-week-1-box'),
                mobileOutgoingWeek2Box: document.getElementById('mobile-outgoing-week-2-box')
            };

            // ========================================
            // SHARED GAME STATE
            // ========================================
            const gameState = {
                // Configuration
                config: {
                    factoryInventory: 1000, // Factory has infinite/high stock
                    orderRange: { min: 10, max: 20 }
                },

                // Current values (shared between mobile/desktop)
                incomingOrder: 0,       // Order received from Wholesaler
                orderValue: 0,          // Order placed to Factory
                distributorInventory: 50,

                // Calculated delivery values
                factoryDelivery: 0,     // What Factory sends to us
                distributorOutgoing: 0, // What we send to Wholesaler

                // Week slot values
                orangeWeek1: 20,
                orangeWeek2: 30,
                purpleWeek1: 25,
                purpleWeek2: 20,

                // Phase 2 clone references (for Phase 3 animations)
                phase2: {
                    deliveryClone: null,
                    outgoingClone: null
                },

                // Helper methods
                generateIncomingOrder() {
                    const { min, max } = this.config.orderRange;
                    this.incomingOrder = Math.floor(Math.random() * (max - min + 1)) + min;
                    return this.incomingOrder;
                },

                calculateDelivery(available, requested) {
                    return Math.min(Math.max(0, available), Math.max(0, requested));
                },

                processFactoryOrder(orderValue) {
                    this.orderValue = orderValue;
                    // Factory always delivers full amount (simplified)
                    this.factoryDelivery = orderValue; 
                    return this.factoryDelivery;
                },

                processDistributorOrder(orderValue) {
                    // We fill Wholesaler's order from our inventory
                    this.distributorOutgoing = this.calculateDelivery(this.distributorInventory, orderValue);
                    this.distributorInventory = Math.max(0, this.distributorInventory - orderValue);
                    return { outgoing: this.distributorOutgoing, newInventory: this.distributorInventory };
                },

                receiveDelivery(amount) {
                    this.distributorInventory += amount;
                    return this.distributorInventory;
                },

                advanceWeeks() {
                    // Orange weeks (incoming deliveries from Factory)
                    this.orangeWeek2 = this.orangeWeek1;
                    this.orangeWeek1 = this.factoryDelivery;
                    // Purple weeks (outgoing deliveries to Wholesaler)
                    this.purpleWeek2 = this.purpleWeek1;
                    this.purpleWeek1 = this.distributorOutgoing;
                }
            };

            // Sync gameState to all DOM elements
            function syncStateToDOM() {
                // Distributor inventory (both mobile and desktop)
                const desktopInv = els.distributorInventory?.querySelector('.text-5xl');
                const mobileInv = document.getElementById('distributor-inventory-mobile')?.querySelector('.text-3xl');
                if (desktopInv) desktopInv.innerText = gameState.distributorInventory;
                if (mobileInv) mobileInv.innerText = gameState.distributorInventory;

                // Week slots (desktop)
                if (els.orangeWeek1) els.orangeWeek1.innerText = gameState.orangeWeek1;
                if (els.orangeWeek2) els.orangeWeek2.innerText = gameState.orangeWeek2;
                if (els.purpleWeek1) els.purpleWeek1.innerText = gameState.purpleWeek1;
                if (els.purpleWeek2) els.purpleWeek2.innerText = gameState.purpleWeek2;

                // Week slots (mobile)
                if (els.mobileDeliveryWeek1) els.mobileDeliveryWeek1.innerText = gameState.orangeWeek1;
                if (els.mobileDeliveryWeek2) els.mobileDeliveryWeek2.innerText = gameState.orangeWeek2;
                if (els.mobileOutgoingWeek1) els.mobileOutgoingWeek1.innerText = gameState.purpleWeek1;
                if (els.mobileOutgoingWeek2) els.mobileOutgoingWeek2.innerText = gameState.purpleWeek2;
            }

            // Initialize DOM from gameState on page load
            syncStateToDOM();

            // --- Mobile Detection ---
            const isMobile = () => window.innerWidth < 1024;

            // --- Get current order input based on screen size ---
            const getCurrentOrderInput = () => isMobile() ? mobileOrderInput : orderInput;
            const getCurrentBtnSend = () => isMobile() ? mobileBtnSend : btnSend;

            // --- Input Logic ---
            const validateInput = () => {
                const currentInput = getCurrentOrderInput();
                const currentBtn = getCurrentBtnSend();
                const val = currentInput?.value;
                const isEmpty = val === '' || val === null;

                if (currentBtn) {
                    if (isEmpty) {
                        currentBtn.disabled = true;
                        currentBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        currentBtn.classList.remove('hover:bg-accent/10');
                    } else {
                        currentBtn.disabled = false;
                        currentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        currentBtn.classList.add('hover:bg-accent/10');
                    }
                }
            };

            // Desktop input handlers
            if (btnUp) btnUp.addEventListener('click', () => { orderInput.stepUp(); validateInput(); });
            if (btnDown) btnDown.addEventListener('click', () => { orderInput.stepDown(); validateInput(); });
            if (orderInput) {
                orderInput.addEventListener('input', validateInput);
                orderInput.addEventListener('change', () => { 
                    if (orderInput.value < 0) orderInput.value = 0;
                    validateInput(); 
                });
            }

            // Mobile input handlers
            if (mobileBtnUp) mobileBtnUp.addEventListener('click', () => { mobileOrderInput.stepUp(); validateInput(); });
            if (mobileBtnDown) mobileBtnDown.addEventListener('click', () => { mobileOrderInput.stepDown(); validateInput(); });
            if (mobileOrderInput) {
                mobileOrderInput.addEventListener('input', validateInput);
                mobileOrderInput.addEventListener('change', () => { 
                    if (mobileOrderInput.value < 0) mobileOrderInput.value = 0;
                    validateInput(); 
                });
            }

            validateInput();

            // --- Animation Helper ---
            const animateClone = (sourceEl, targetEl, textOverride = null, pathType = 'direct', onComplete = null, persist = false, overwrite = false) => {
                if (!sourceEl || !targetEl) {
                    console.error("Animation Source or Target missing", { sourceEl, targetEl });
                    return;
                }
                
                const rectSource = sourceEl.getBoundingClientRect();
                const rectTarget = targetEl.getBoundingClientRect();
                
                // Create Ghost
                const clone = sourceEl.cloneNode(true);
                
                // Clean up clone IDs/inputs
                clone.id = '';
                const input = clone.querySelector('input');
                if (input) {
                    const val = input.value;
                    const span = document.createElement('span');
                    span.innerText = val;
                    span.className = input.className.replace('bg-transparent', ''); 
                    span.style.display = 'inline-block';
                    input.replaceWith(span);
                    const btns = clone.querySelectorAll('button');
                    btns.forEach(b => b.remove());
                }
                
                if (textOverride !== null) {
                    const numberDiv = clone.querySelector('.font-bold') || clone;
                    numberDiv.innerText = textOverride;
                }

                // Style Ghost
                clone.style.position = 'fixed';
                clone.style.left = `${rectSource.left}px`;
                clone.style.top = `${rectSource.top}px`;
                clone.style.width = `${rectSource.width}px`;
                clone.style.height = `${rectSource.height}px`;
                clone.style.margin = '0';
                clone.style.zIndex = '9999';
                clone.style.pointerEvents = 'none';
                clone.style.transition = 'none';
                document.body.appendChild(clone);

                // Calculate Keyframes
                let keyframes;
                const deltaX = rectTarget.left - rectSource.left;
                const deltaY = rectTarget.top - rectSource.top;

                // Path Logic
                if (pathType === 'dogleg') {
                    const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                    const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                    const waypointX = deltaX; 
                    const finalX = deltaX + centerOffsetX; 
                    const finalY = deltaY + centerOffsetY; 
                    keyframes = [
                        { transform: 'translate(0, 0)', offset: 0 },
                        { transform: `translate(${waypointX}px, 0)`, offset: 0.6 },
                        { transform: `translate(${finalX}px, ${finalY}px)`, offset: 1 }
                    ];
                } else if (pathType === 'vertical-dogleg') {
                    const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                    const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                    const finalX = deltaX + centerOffsetX;
                    const finalY = deltaY + centerOffsetY;
                    const adjustedY = finalY; // Move to Y level first
                    keyframes = [
                        { transform: 'translate(0, 0)', offset: 0 },
                        { transform: `translate(0, ${adjustedY}px)`, offset: 0.6 },
                        { transform: `translate(${finalX}px, ${adjustedY}px)`, offset: 1 }
                    ];
                } else if (pathType === 'vertical-align-y') {
                    const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                    const finalY = deltaY + centerOffsetY;
                    keyframes = [
                        { transform: 'translate(0, 0)' },
                        { transform: `translate(0, ${finalY}px)` }
                    ];
                } else if (pathType === 'horizontal') {
                    const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                    const finalX = deltaX + centerOffsetX;
                    keyframes = [
                        { transform: 'translate(0, 0)' },
                        { transform: `translate(${finalX}px, 0)` }
                    ];
                } else if (pathType === 'vertical-down' || pathType === 'vertical-up') {
                     const centerOffsetX = (rectTarget.width - rectSource.width) / 2;
                     const centerOffsetY = (rectTarget.height - rectSource.height) / 2;
                     const finalX = deltaX + centerOffsetX;
                     const finalY = deltaY + centerOffsetY;
                     keyframes = [
                         { transform: 'translate(0, 0)' },
                         { transform: `translate(${finalX}px, ${finalY}px)` }
                     ];
                } else {
                    keyframes = [
                        { transform: 'translate(0, 0)' },
                        { transform: `translate(${deltaX}px, ${deltaY}px)` }
                    ];
                }

                // Animate
                const animation = clone.animate(keyframes, {
                    duration: 2000,
                    easing: 'ease-in-out',
                    fill: 'forwards'
                });

                animation.onfinish = () => {
                    if (!persist) clone.remove();
                    if (overwrite || targetEl.innerText.trim() === '' || targetEl.innerText.trim() === '&nbsp;') {
                        targetEl.innerText = input ? input.value : clone.innerText.trim();
                    }
                    if (onComplete) onComplete(clone);
                };
            };

            // --- Mobile Animation Function ---
            const startMobileAnimation = () => {
                console.log("Starting Mobile Animations (Vertical)...");

                const orderVal = mobileOrderInput?.value || '0';
                const randomIncomingOrder = gameState.generateIncomingOrder();
                const wholesalerOrderMobile = document.querySelector('.mobile-wholesaler-order');

                // ========================================
                // PHASE 1: Two parallel animations (both DOWNWARD)
                // 1. Wholesaler Order -> Distributor Order Received
                // 2. Distributor Order -> Factory Order
                // ========================================

                // --- Animation 1: Wholesaler Order -> Distributor Order Received ---
                if (wholesalerOrderMobile && mobileDistributorOrderReceived) {
                    animateClone(wholesalerOrderMobile, mobileDistributorOrderReceived, randomIncomingOrder.toString(), 'vertical-down', () => {
                         if (mobileDistributorOrderReceived) mobileDistributorOrderReceived.innerText = randomIncomingOrder;
                         // Also update shared Desktop element if exists
                         if (els.distributorOrderReceivedInner) els.distributorOrderReceivedInner.innerText = randomIncomingOrder;
                    }, false, true);
                }

                // --- Animation 2: Distributor Order -> Factory Order ---
                const mobileOrderValueBox = mobileOrderInput?.parentElement;
                if (mobileOrderValueBox && mobileFactoryOrder) {
                    animateClone(mobileOrderValueBox, mobileFactoryOrder, orderVal, 'vertical-down', () => {
                        if (mobileFactoryOrder) mobileFactoryOrder.innerText = orderVal;
                         // Also update shared Desktop element
                        if (els.factoryOrderInner) els.factoryOrderInner.innerText = orderVal;
                        if (mobileOrderInput) mobileOrderInput.value = '';
                    }, false, true);
                }

                // --- Animation 3: Outgoing (Purple) Week 2 -> Wholesaler (UP along pipe) ---
                // The target "Wholesaler Inventory" is effectively the top node
                const wholesalerInventoryMobile = document.getElementById('wholesaler-inventory-downstream');
                
                if (els.mobileOutgoingWeek2 && wholesalerInventoryMobile) {
                    const week2Rect = els.mobileOutgoingWeek2.getBoundingClientRect();
                    const invRect = wholesalerInventoryMobile.getBoundingClientRect();
                    const vertDist = week2Rect.top - invRect.bottom; // approximate
                    // Just animate to fade out up top
                    const clone = els.mobileOutgoingWeek2.cloneNode(true);
                     clone.style.position = 'fixed';
                     clone.style.left = week2Rect.left + 'px';
                     clone.style.top = week2Rect.top + 'px';
                     clone.style.zIndex = '9999';
                     document.body.appendChild(clone);
                     
                     clone.animate([
                         { transform: 'translate(0,0)', opacity: 1 },
                         { transform: `translate(0, -${vertDist + 50}px)`, opacity: 0 }
                     ], { duration: 2000, easing: 'linear' }).onfinish = () => clone.remove();
                     
                     els.mobileOutgoingWeek2.style.opacity = '0';
                }

                // --- Animation 4: Outgoing Week 1 -> Week 2 (UP) ---
                if (els.mobileOutgoingWeek1 && els.mobileOutgoingWeek2) {
                     animateClone(els.mobileOutgoingWeek1, els.mobileOutgoingWeek2, gameState.purpleWeek1.toString(), 'vertical-up', () => {
                        gameState.purpleWeek2 = gameState.purpleWeek1;
                        els.mobileOutgoingWeek2.innerText = gameState.purpleWeek2;
                        els.mobileOutgoingWeek2.style.opacity = '1';
                        syncStateToDOM();
                     }, false, true);
                     els.mobileOutgoingWeek1.style.opacity = '0';
                }

                // --- Animation 5: Delivery (Orange) Week 2 -> Distributor Inventory (DOWN) ---
                const distributorInventoryMobile = document.getElementById('distributor-inventory-mobile');
                if (els.mobileDeliveryWeek2 && distributorInventoryMobile) {
                    animateClone(els.mobileDeliveryWeek2, distributorInventoryMobile, gameState.orangeWeek2.toString(), 'vertical-down', () => {
                        gameState.receiveDelivery(gameState.orangeWeek2);
                        syncStateToDOM();
                    }, false);
                    els.mobileDeliveryWeek2.style.opacity = '0';
                }

                // --- Animation 6: Delivery (Orange) Week 1 -> Week 2 (DOWN) ---
                if (els.mobileDeliveryWeek1 && els.mobileDeliveryWeek2) {
                    animateClone(els.mobileDeliveryWeek1, els.mobileDeliveryWeek2, gameState.orangeWeek1.toString(), 'vertical-down', () => {
                        gameState.orangeWeek2 = gameState.orangeWeek1;
                        els.mobileDeliveryWeek2.innerText = gameState.orangeWeek2;
                        els.mobileDeliveryWeek2.style.opacity = '1';
                        syncStateToDOM();
                    }, false, true);
                    els.mobileDeliveryWeek1.style.opacity = '0';
                }

                // ========================================
                // PHASE 2: Processing & Transitions
                // ========================================
                setTimeout(() => {
                    console.log("Starting Phase 2...");
                    const distributorInventoryMobile = document.getElementById('distributor-inventory-mobile');
                    
                    // --- Phase 2a: Factory Order -> Turns into Orange Delivery (Week 1) ---
                    // In our simplified Factory model, order becomes delivery immediately next week
                    // Animation: Just fade/morph Factory Order box into an Orange delivery style?
                    // For now, we'll just handle the logic in Phase 3 appearing at top
                    
                    // --- Phase 2b: Distributor Incoming Order -> Inventory -> Outgoing (Purple) ---
                    if (mobileDistributorOrderReceived && distributorInventoryMobile) {
                        // Move Order LEFT/CENTER to Inventory
                        const orderRect = mobileDistributorOrderReceived.getBoundingClientRect();
                        const invRect = distributorInventoryMobile.getBoundingClientRect();
                        const horizDist = invRect.left + (invRect.width/2) - orderRect.left - (orderRect.width/2);
                        
                        const orderVal = gameState.incomingOrder;
                        const { outgoing, newInventory } = gameState.processDistributorOrder(orderVal);
                        
                        const clone = mobileDistributorOrderReceived.cloneNode(true);
                        clone.style.position = 'fixed';
                        clone.style.left = orderRect.left + 'px';
                        clone.style.top = orderRect.top + 'px';
                        clone.style.zIndex = 9999;
                        document.body.appendChild(clone);
                        
                        // Animate to Inventory
                        clone.animate([
                            { transform: 'translate(0,0)' },
                            { transform: `translate(${horizDist}px, 0)` }
                        ], { duration: 1000, fill: 'forwards' }).onfinish = () => {
                            // Morph to Purple
                            clone.style.backgroundColor = '#8B5CF6'; // Accent color
                            clone.innerText = outgoing;
                            
                            syncStateToDOM(); // Update inventory number
                            
                            // Phase 3: Move from Inventory to Purple Week 1
                            setTimeout(() => {
                                if (els.mobileOutgoingWeek1) {
                                    const targetRect = els.mobileOutgoingWeek1.getBoundingClientRect();
                                    // Current clone position (approx)
                                    const currentRect = clone.getBoundingClientRect();
                                    const dX = targetRect.left - currentRect.left;
                                    const dY = targetRect.top - currentRect.top;
                                    
                                    clone.animate([
                                        { transform: `translate(${horizDist}px, 0)` },
                                        { transform: `translate(${horizDist + dX}px, ${dY}px)` }
                                    ], { duration: 1000, fill: 'forwards' }).onfinish = () => {
                                        gameState.purpleWeek1 = outgoing;
                                        els.mobileOutgoingWeek1.innerText = outgoing;
                                        els.mobileOutgoingWeek1.style.opacity = '1';
                                        clone.remove();
                                        
                                        // Re-enable inputs
                                        setTimeout(() => {
                                             if (mobileOrderInput) mobileOrderInput.disabled = false;
                                             if (mobileBtnSend) {
                                                 mobileBtnSend.querySelector('span').innerText = "Send";
                                                 mobileBtnSend.disabled = false;
                                                 mobileBtnSend.classList.remove('opacity-50', 'cursor-not-allowed');
                                                 validateInput();
                                             }
                                        }, 500);
                                    };
                                }
                            }, 500);
                        };
                    }
                    
                    // --- Phase 3b: Factory "Processing" -> New Orange Delivery at Week 1 ---
                    // Factory order (from Phase 1) becomes Delivery Week 1
                    setTimeout(() => {
                        const deliveredAmount = gameState.processFactoryOrder(parseInt(orderVal));
                        gameState.orangeWeek1 = deliveredAmount;
                        
                        // Animate "appearance" at Week 1 slot
                        if (els.mobileDeliveryWeek1) {
                            // Maybe animate from Factory Order slot up to Week 1?
                            // Factory Order is at bottom, Week 1 is above.
                            if (mobileFactoryOrder) {
                                animateClone(mobileFactoryOrder, els.mobileDeliveryWeek1, deliveredAmount.toString(), 'vertical-up', () => {
                                    els.mobileDeliveryWeek1.innerText = deliveredAmount;
                                    els.mobileDeliveryWeek1.style.opacity = '1';
                                    syncStateToDOM();
                                }, false, true);
                            }
                        }
                    }, 1500);

                }, 2500);
            };

            // --- Desktop Animation Function ---
            const startDesktopAnimation = () => {
                console.log("Starting Desktop Animations (Horizontal)...");
                
                const orderVal = parseInt(orderInput.value) || 0;
                const randomIncomingOrder = gameState.generateIncomingOrder();
                
                // 1. Wholesaler Order -> Distributor Order Received
                if (els.wholesalerOrder && els.distributorOrderReceived) {
                    animateClone(els.wholesalerOrder, els.distributorOrderReceived, randomIncomingOrder.toString(), 'horizontal', () => {
                        if(els.distributorOrderReceivedInner) els.distributorOrderReceivedInner.innerText = randomIncomingOrder;
                    }, false, true);
                }
                
                // 2. Distributor Order -> Factory Order
                if (els.distributorOrderInner && els.factoryOrderInner) {
                    animateClone(els.distributorOrderInner, els.factoryOrderInner, orderVal.toString(), 'direct', () => {
                         els.factoryOrderInner.innerText = orderVal;
                         // Clear input
                         if(orderInput) orderInput.value = '';
                    }, false, true);
                }
                
                // 3. Purple (Outgoing) Week 2 -> Wholesaler Inventory
                if (els.purpleWeek2 && els.wholesalerInventory) {
                    animateClone(els.purpleWeek2, els.wholesalerInventory, null, 'dogleg');
                    els.purpleWeek2.style.opacity = '0';
                }
                
                // 4. Purple (Outgoing) Week 1 -> Week 2
                if (els.purpleWeek1 && els.purpleWeek2) {
                     animateClone(els.purpleWeek1, els.purpleWeek2, gameState.purpleWeek1.toString(), 'direct', () => {
                         gameState.purpleWeek2 = gameState.purpleWeek1;
                         els.purpleWeek2.innerText = gameState.purpleWeek2;
                         els.purpleWeek2.style.opacity = '1';
                     }, false, true);
                     els.purpleWeek1.style.opacity = '0';
                }
                
                // 5. Orange (Delivery) Week 2 -> Distributor Inventory
                if (els.orangeWeek2 && els.distributorInventory) {
                    animateClone(els.orangeWeek2, els.distributorInventory, null, 'dogleg', () => {
                        gameState.receiveDelivery(gameState.orangeWeek2);
                        syncStateToDOM();
                    });
                    els.orangeWeek2.style.opacity = '0';
                }
                
                // 6. Orange (Delivery) Week 1 -> Week 2
                if (els.orangeWeek1 && els.orangeWeek2) {
                    animateClone(els.orangeWeek1, els.orangeWeek2, gameState.orangeWeek1.toString(), 'direct', () => {
                        gameState.orangeWeek2 = gameState.orangeWeek1;
                        els.orangeWeek2.innerText = gameState.orangeWeek2;
                        els.orangeWeek2.style.opacity = '1';
                    }, false, true);
                    els.orangeWeek1.style.opacity = '0';
                }
                
                // PHASE 2: Processing
                setTimeout(() => {
                    // 1. Distributor Order Received -> Inventory -> Purple Week 1
                    if (els.distributorOrderReceivedInner && els.distributorInventory) {
                        animateClone(els.distributorOrderReceivedInner, els.distributorInventory, null, 'vertical-align-y', (clone) => {
                             // Logic
                             const { outgoing } = gameState.processDistributorOrder(randomIncomingOrder);
                             syncStateToDOM();
                             
                             // Morph clone
                             clone.style.backgroundColor = '#8B5CF6'; // Purple
                             clone.innerText = outgoing;
                             
                             // Move to Purple Week 1
                             setTimeout(() => {
                                 if (els.purpleWeek1) {
                                     const targetRect = els.purpleWeek1.getBoundingClientRect();
                                     const currentRect = clone.getBoundingClientRect();
                                     const dX = targetRect.left - currentRect.left;
                                     const dY = targetRect.top - currentRect.top;
                                     
                                     clone.animate([
                                         { transform: 'translate(0,0)' },
                                         { transform: `translate(${dX}px, ${dY}px)` }
                                     ], { duration: 1000, fill: 'forwards' }).onfinish = () => {
                                         gameState.purpleWeek1 = outgoing;
                                         els.purpleWeek1.innerText = outgoing;
                                         els.purpleWeek1.style.opacity = '1';
                                         clone.remove();
                                         
                                         // Reset UI
                                          if (btnSend) {
                                                btnSend.querySelector('span').innerText = "Send";
                                                btnSend.disabled = false;
                                                btnSend.classList.remove('opacity-50', 'cursor-not-allowed');
                                                validateInput();
                                            }
                                            if (orderInput) orderInput.disabled = false;
                                            if (btnUp) btnUp.disabled = false;
                                            if (btnDown) btnDown.disabled = false;
                                     };
                                 }
                             }, 500);
                        }, true);
                    }
                    
                    // 2. Factory Order -> Orange Week 1
                    // Factory produces instantly next week
                    setTimeout(() => {
                        const deliveredAmount = gameState.processFactoryOrder(orderVal);
                        if (els.factoryOrderInner && els.orangeWeek1) {
                             animateClone(els.factoryOrderInner, els.orangeWeek1, deliveredAmount.toString(), 'dogleg', () => { // dogleg or direct depending on pos
                                 gameState.orangeWeek1 = deliveredAmount;
                                 els.orangeWeek1.innerText = deliveredAmount;
                                 els.orangeWeek1.style.opacity = '1';
                             }, false, true);
                        }
                    }, 1000);
                    
                }, 2500);
            };

            // --- Main Animation Entry Point ---
            window.startState3Animation = () => {
                console.log("Starting State 3 Animations...");
                if (isMobile()) {
                    startMobileAnimation();
                } else {
                    startDesktopAnimation();
                }
            };

            // --- Send Button Listeners ---
            if (btnSend) {
                btnSend.addEventListener('click', () => {
                    orderInput.disabled = true;
                    btnUp.disabled = true;
                    btnDown.disabled = true;
                    btnSend.disabled = true;
                    btnSend.querySelector('span').innerText = "WAIT";
                    btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                    btnSend.classList.remove('hover:bg-accent/10');

                    setTimeout(() => {
                        btnSend.querySelector('span').innerText = "SENT";
                        startState3Animation();
                    }, 3000); // 3s wait
                });
            }
            
            if (mobileBtnSend) {
                mobileBtnSend.addEventListener('click', () => {
                    mobileOrderInput.disabled = true;
                    mobileBtnSend.disabled = true;
                    mobileBtnSend.querySelector('span').innerText = "WAIT";
                    mobileBtnSend.classList.add('opacity-50', 'cursor-not-allowed');
                    
                     setTimeout(() => {
                        mobileBtnSend.querySelector('span').innerText = "SENT";
                        startState3Animation();
                    }, 1000); // faster on mobile
                });
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGameLogic);
        } else {
            initGameLogic();
        }

        // Statistics Calculator & Components (Recharts)
        // ... (Rest of the file content is the React components) ...

        // Statistics Calculator Utility
        const StatisticsCalculator = {
            calculate(values) {
                if (!values || values.length === 0) return this.getEmptyStats();

                const n = values.length;
                const sorted = [...values].sort((a, b) => a - b);

                // Central tendency
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / n;
                const median = this.calculateMedian(sorted);
                const mode = this.calculateMode(values);

                // Dispersion
                const min = sorted[0];
                const max = sorted[n - 1];
                const range = max - min;
                const variance = n > 1 ? values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / (n - 1) : 0;
                const stdDev = Math.sqrt(variance);

                // Distribution shape
                const coeffVar = mean !== 0 ? (stdDev / Math.abs(mean)) * 100 : null;
                const skewness = this.calculateSkewness(values, mean, stdDev, n);
                const kurtosis = this.calculateKurtosis(values, mean, stdDev, n);
                const iqr = this.calculateIQR(sorted);

                // Inference (95% CI using CLT)
                const sem = n > 0 ? stdDev / Math.sqrt(n) : 0;
                const tCritical = this.getTCritical(n - 1);
                const marginError = tCritical * sem;
                const ci95Lower = mean - marginError;
                const ci95Upper = mean + marginError;

                return { n, min, max, mean, stdDev, coeffVar, mode, median, range, iqr, skewness, kurtosis, sem, marginError, ci95Lower, ci95Upper };
            },

            calculateMedian(sorted) {
                const n = sorted.length;
                const mid = Math.floor(n / 2);
                return n % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            },

            calculateMode(values) {
                const freq = {};
                values.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const maxFreq = Math.max(...Object.values(freq));
                if (maxFreq === 1) return 'None';
                const modes = Object.keys(freq).filter(k => freq[k] === maxFreq).map(Number);
                return modes.length === values.length ? 'None' : modes.join(', ');
            },

            calculateSkewness(values, mean, stdDev, n) {
                if (stdDev === 0 || n < 3) return null;
                const m3 = values.reduce((s, v) => s + Math.pow(v - mean, 3), 0) / n;
                const m2 = values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / n;
                return (m3 / Math.pow(m2, 1.5)) * Math.sqrt(n * (n - 1)) / (n - 2);
            },

            calculateKurtosis(values, mean, stdDev, n) {
                if (stdDev === 0 || n < 4) return null;
                const m4 = values.reduce((s, v) => s + Math.pow(v - mean, 4), 0) / n;
                const m2 = values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / n;
                const g2 = (m4 / Math.pow(m2, 2)) - 3;
                return ((n + 1) * g2 + 6) * (n - 1) / ((n - 2) * (n - 3));
            },

            calculateIQR(sorted) {
                const n = sorted.length;
                const q1 = sorted[Math.floor(n * 0.25)];
                const q3 = sorted[Math.floor(n * 0.75)];
                return q3 - q1;
            },

            getTCritical(df) {
                const tTable = {1:12.706,2:4.303,3:3.182,4:2.776,5:2.571,6:2.447,7:2.365,8:2.306,9:2.262,10:2.228,
                                11:2.201,12:2.179,13:2.160,14:2.145,15:2.131,20:2.086,25:2.060,29:2.045};
                if (df >= 30) return 1.96;
                return tTable[df] || tTable[Math.max(...Object.keys(tTable).map(Number).filter(k => k <= df))] || 2.0;
            },

            getEmptyStats() {
                return { n:0, min:'-', max:'-', mean:'-', stdDev:'-', coeffVar:'-', mode:'-', median:'-',
                         range:'-', iqr:'-', skewness:'-', kurtosis:'-', sem:'-', marginError:'-', ci95Lower:'-', ci95Upper:'-' };
            }
        };

        // Cost rates
        const HOLDING_COST_RATE = 10;   // $ per unit of inventory per week
        const BACKORDER_COST_RATE = 20; // $ per unit of backorder per week

        // Initial conditions
        const INITIAL_INVENTORY = 50;

        // External inputs: orders (from retailer) and deliveries (from distributor)
        const weeklyInputs = [
            { week: '1', orders: 10, deliveries: 0 },
            { week: '2', orders: 12, deliveries: 10 },
            { week: '3', orders: 15, deliveries: 10 },
            { week: '4', orders: 25, deliveries: 12 },
            { week: '5', orders: 40, deliveries: 15 },
            { week: '6', orders: 35, deliveries: 20 },
            { week: '7', orders: 30, deliveries: 25 },
            { week: '8', orders: 20, deliveries: 30 },
            { week: '9', orders: 15, deliveries: 25 },
            { week: '10', orders: 12, deliveries: 20 },
        ];

        // Simulate the game: compute inventory, backorders, outgoing orders
        let inventory = INITIAL_INVENTORY;
        let backorders = 0;
        let cumHolding = 0;
        let cumBackorder = 0;

        const data = weeklyInputs.map(input => {
            // Available stock = current inventory + incoming deliveries
            const available = inventory + input.deliveries;

            // Total orders = new orders + any backorders from previous weeks
            const totalOrders = input.orders + backorders;

            // Outgoing deliveries (what we actually ship) = min(available, totalOrders)
            const outgoingDeliveries = Math.min(available, totalOrders);

            // New inventory = max(0, available - totalOrders)
            const newInventory = Math.max(0, available - totalOrders);

            // New backorders = max(0, totalOrders - available)
            const newBackorders = Math.max(0, totalOrders - available);

            // Costs based on END-of-period inventory/backorders
            const holdingCost = newInventory * HOLDING_COST_RATE;
            const backorderCost = newBackorders * BACKORDER_COST_RATE;
            cumHolding += holdingCost;
            cumBackorder += backorderCost;

            const row = {
                week: input.week,
                incomingOrders: input.orders,         // Orders from retailer
                deliveries: input.deliveries,         // Deliveries from distributor
                outgoingOrders: outgoingDeliveries,   // What we ship = min(available, orders)
                inventory: newInventory,              // End-of-period inventory
                backorders: newBackorders,            // End-of-period backorders
                holdingCost,
                backorderCost,
                cumHoldingCost: cumHolding,
                cumBackorderCost: cumBackorder,
                totalCost: cumHolding + cumBackorder
            };

            // Update state for next week
            inventory = newInventory;
            backorders = newBackorders;

            return row;
        });

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-mono-surface border border-mono-light/20 p-3 rounded shadow-xl">
                        <p className="text-mono-text font-bold mb-1">{label}</p>
                        {payload.map((entry, index) => (
                            <p key={index} style={{ color: entry.color }} className="text-sm">
                                {entry.name}: {entry.value}
                            </p>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // StatItem - individual stat display
        const StatItem = ({ label, value }) => (
            <div className="flex justify-between items-center">
                <span className="text-xs text-mono-light">{label}</span>
                <span className="font-mono text-sm font-medium text-mono-text">{value}</span>
            </div>
        );

        // StatGroup - grouped statistics with header
        const StatGroup = ({ title, children }) => (
            <div className="bg-mono-bg/30 rounded-xl p-3 border border-mono-light/10">
                <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">{title}</h4>
                <div className="space-y-1.5">{children}</div>
            </div>
        );

        // Metrics configuration
        const METRICS = [
            { id: 'inventory', label: 'Inventory' },
            { id: 'backorders', label: 'Backorders' },
            { id: 'incomingOrders', label: 'Incoming' },
            { id: 'outgoingOrders', label: 'Outgoing' },
            { id: 'holdingCost', label: 'Hold $' },
            { id: 'backorderCost', label: 'Back $' },
            { id: 'totalCost', label: 'Total $' },
        ];

        // StatisticsPanel - main statistics component with tabs
        const StatisticsPanel = ({ gameData }) => {
            const [activeMetric, setActiveMetric] = React.useState('inventory');
            const tabsRef = React.useRef(null);

            const metricValues = React.useMemo(() =>
                gameData.map(week => week[activeMetric] ?? 0), [gameData, activeMetric]);

            const stats = React.useMemo(() =>
                StatisticsCalculator.calculate(metricValues), [metricValues]);

            const fmt = (v, d = 2) => {
                if (v === '-' || v === 'None' || v === null) return v ?? '-';
                return typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(d)) : v;
            };

            const scrollTabs = (direction) => {
                const container = tabsRef.current;
                if (!container) return;
                const scrollAmount = 80;
                const newPos = direction === 'left'
                    ? Math.max(0, container.scrollLeft - scrollAmount)
                    : container.scrollLeft + scrollAmount;
                container.scrollTo({ left: newPos, behavior: 'smooth' });
            };

            return (
                <div className="flex flex-col w-full">
                    {/* Header with title and sample size */}
                    <div className="flex items-center justify-between mb-3 flex-shrink-0 gap-2">
                        <h3 className="font-semibold text-mono-text text-sm sm:text-base truncate">Statistics</h3>
                        <span className="text-[10px] text-mono-light uppercase tracking-wider whitespace-nowrap">n={gameData.length}</span>
                    </div>

                    {/* Metric Tabs - Single Row with Arrow Navigation */}
                    <div className="flex items-center gap-1 mb-4 pb-2 border-b border-mono-light/10 overflow-hidden flex-shrink-0">
                        <button onClick={() => scrollTabs('left')} className="p-0.5 text-mono-light hover:text-mono-text hover:bg-mono-bg/30 rounded transition-all flex-shrink-0">
                            <span className="material-symbols-outlined text-base">chevron_left</span>
                        </button>
                        <div ref={tabsRef} className="flex gap-1 overflow-x-scroll flex-1 min-w-0" style={{scrollbarWidth: 'none', msOverflowStyle: 'none', scrollBehavior: 'smooth'}}>
                            {METRICS.map(m => (
                                <button key={m.id} onClick={() => setActiveMetric(m.id)}
                                    className={`px-2 py-1 text-xs font-medium rounded transition-all whitespace-nowrap flex-shrink-0
                                        ${activeMetric === m.id
                                            ? 'bg-accent/20 text-accent border-b-2 border-accent'
                                            : 'text-mono-light hover:text-mono-text hover:bg-mono-bg/30'}`}>
                                    {m.label}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => scrollTabs('right')} className="p-0.5 text-mono-light hover:text-mono-text hover:bg-mono-bg/30 rounded transition-all flex-shrink-0">
                            <span className="material-symbols-outlined text-base">chevron_right</span>
                        </button>
                    </div>

                    {/* Statistics Grid - Single Column */}
                    <div className="grid grid-cols-1 gap-3">
                        <StatGroup title="Central Tendency">
                            <StatItem label="Mean" value={fmt(stats.mean)} />
                            <StatItem label="Median" value={fmt(stats.median)} />
                            <StatItem label="Mode" value={stats.mode} />
                        </StatGroup>

                        <StatGroup title="Dispersion">
                            <StatItem label="Min" value={fmt(stats.min, 0)} />
                            <StatItem label="Max" value={fmt(stats.max, 0)} />
                            <StatItem label="Range" value={fmt(stats.range, 0)} />
                            <StatItem label="Std Dev" value={fmt(stats.stdDev)} />
                        </StatGroup>

                        <StatGroup title="Distribution">
                            <StatItem label="CV" value={stats.coeffVar !== null ? `${fmt(stats.coeffVar)}%` : '-'} />
                            <StatItem label="Skewness" value={fmt(stats.skewness)} />
                            <StatItem label="Kurtosis" value={fmt(stats.kurtosis)} />
                            <StatItem label="IQR" value={fmt(stats.iqr)} />
                        </StatGroup>

                        <StatGroup title="Inference (95% CI)">
                            <StatItem label="Std Error" value={fmt(stats.sem)} />
                            <StatItem label="Margin" value={fmt(stats.marginError)} />
                            <StatItem label="CI Lower" value={fmt(stats.ci95Lower)} />
                            <StatItem label="CI Upper" value={fmt(stats.ci95Upper)} />
                        </StatGroup>
                    </div>
                </div>
            );
        };

        // MetricsPanel - KPI component showing key performance indicators
        const MetricsPanel = ({ gameData }) => {
            // Calculate metrics
            const metrics = React.useMemo(() => {
                if (!gameData || gameData.length === 0) return { totalCost: 0, serviceLevel: 0, fillRate: 0 };

                // Total Cost: final cumulative cost
                const totalCost = gameData[gameData.length - 1].totalCost;

                // Service Level: ratio of fully delivered orders to total orders
                // A fully delivered order is when outgoingOrders >= incomingOrders (orders)
                const fullyDeliveredOrders = gameData.filter(w => w.outgoingOrders >= w.incomingOrders).length;
                const serviceLevel = (fullyDeliveredOrders / gameData.length) * 100;

                // Fill Rate: ratio of total delivered to total ordered
                const totalDelivered = gameData.reduce((sum, w) => sum + w.outgoingOrders, 0);
                const totalOrdered = gameData.reduce((sum, w) => sum + w.incomingOrders, 0);
                const fillRate = totalOrdered > 0 ? (totalDelivered / totalOrdered) * 100 : 0;

                return { totalCost, serviceLevel, fillRate };
            }, [gameData]);

            return (
                <div className="flex flex-col h-full">
                    <h3 className="font-semibold mb-3 text-mono-text">Metrics</h3>

                    <div className="flex flex-col gap-4 flex-1">
                        {/* Total Cost */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Total Cost</h4>
                            <div className="text-3xl font-bold text-accent">${metrics.totalCost.toLocaleString()}</div>
                            <p className="text-[10px] text-mono-light mt-1">Cumulative holding + backorder costs</p>
                        </div>

                        {/* Service Level */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Service Level</h4>
                            <div className="text-3xl font-bold" style={{color: metrics.serviceLevel >= 80 ? '#4ade80' : metrics.serviceLevel >= 50 ? '#10B981' : '#f87171'}}>
                                {metrics.serviceLevel.toFixed(1)}%
                            </div>
                            <p className="text-[10px] text-mono-light mt-1">Fully delivered orders / total orders</p>
                        </div>

                        {/* Fill Rate */}
                        <div className="bg-mono-bg/30 rounded-xl p-4 border border-mono-light/10 flex-1 flex flex-col justify-center">
                            <h4 className="text-[10px] uppercase tracking-wider text-mono-text/80 mb-2 font-medium">Fill Rate</h4>
                            <div className="text-3xl font-bold" style={{color: metrics.fillRate >= 90 ? '#4ade80' : metrics.fillRate >= 70 ? '#10B981' : '#f87171'}}>
                                {metrics.fillRate.toFixed(1)}%
                            </div>
                            <p className="text-[10px] text-mono-light mt-1">Delivered quantity / ordered quantity</p>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardCharts = () => {
            // Orders vs Inventory chart toggles
            const [showOrders, setShowOrders] = React.useState(true);
            const [showInventory, setShowInventory] = React.useState(true);
            const [showBackorders, setShowBackorders] = React.useState(true);
            // Cost chart toggles
            const [showHoldingCost, setShowHoldingCost] = React.useState(true);
            const [showBackorderCost, setShowBackorderCost] = React.useState(true);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full h-full">
                    {/* LEFT COLUMN - Charts stacked vertically */}
                    <div className="flex flex-col gap-6">
                        {/* Orders vs Inventory Chart */}
                        <div className="bg-mono-surface p-2 sm:p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1">
                            {/* Header with title and toggles */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 sm:mb-4">
                                <h3 className="font-semibold text-mono-text text-sm sm:text-base">Orders vs. Inventory</h3>
                                <div className="flex items-center gap-2 sm:gap-3">
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showInventory}
                                            onChange={(e) => setShowInventory(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/50 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs" style={{color: '#8B5CF6'}}>Inventory</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showBackorders}
                                            onChange={(e) => setShowBackorders(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/90 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/90">Backorders</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer sm:ml-auto">
                                        <input
                                            type="checkbox"
                                            checked={showOrders}
                                            onChange={(e) => setShowOrders(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/10 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/30">Orders</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex-1 w-full min-h-[180px] sm:min-h-[200px] bg-accent/5 border border-accent/10 rounded-lg overflow-hidden">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={data} margin={{ top: 20, right: 15, left: 5, bottom: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#404040" vertical={false} />
                                        <XAxis dataKey="week" stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Week', position: 'bottom', offset: 0, fill: '#808080', fontSize: 10 }} />
                                        <YAxis stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Units', position: 'insideTopLeft', fill: '#808080', fontSize: 10, dy: -15 }} />
                                        <Tooltip content={<CustomTooltip />} />
                                        {showOrders && <Bar dataKey="outgoingOrders" name="Orders" fill="rgba(139, 92, 246, 0.1)" barSize={12} radius={[2, 2, 0, 0]} />}
                                        {showInventory && <Line type="monotone" dataKey="inventory" name="Inventory" stroke="#8B5CF6" strokeWidth={3} dot={{r: 3, fill: '#8B5CF6'}} activeDot={{r: 6}} />}
                                        {showBackorders && <Line type="monotone" dataKey="backorders" name="Backorders" stroke="rgba(139, 92, 246, 0.9)" strokeWidth={2} dot={{r: 3, fill: 'rgba(139, 92, 246, 0.9)'}} activeDot={{r: 5}} />}
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* Cost Accumulation Chart - Stacked */}
                        <div className="bg-mono-surface p-2 sm:p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1">
                            {/* Header with title and toggles */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 sm:mb-4">
                                <h3 className="font-semibold text-mono-text text-sm sm:text-base">Cost Accumulation</h3>
                                <div className="flex items-center gap-2 sm:gap-4">
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showHoldingCost}
                                            onChange={(e) => setShowHoldingCost(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/50 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs" style={{color: '#8B5CF6'}}>Holding</span>
                                    </label>
                                    <label className="flex items-center gap-1 sm:gap-1.5 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showBackorderCost}
                                            onChange={(e) => setShowBackorderCost(e.target.checked)}
                                            className="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded border-accent/90 bg-mono-bg text-accent focus:ring-accent focus:ring-offset-0 cursor-pointer"
                                        />
                                        <span className="text-[10px] sm:text-xs text-accent/90">Backorder</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex-1 w-full min-h-[180px] sm:min-h-[200px] bg-accent/5 border border-accent/10 rounded-lg overflow-hidden">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={data} margin={{ top: 20, right: 15, left: 5, bottom: 20 }}>
                                        <defs>
                                            <linearGradient id="colorHoldingCostDistributor" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#8B5CF6" stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor="#8B5CF6" stopOpacity={0.2}/>
                                            </linearGradient>
                                            <linearGradient id="colorBackorderCostDistributor" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="rgba(139, 92, 246, 0.9)" stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor="rgba(139, 92, 246, 0.9)" stopOpacity={0.2}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#404040" vertical={false} />
                                        <XAxis dataKey="week" stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Week', position: 'bottom', offset: 0, fill: '#808080', fontSize: 10 }} />
                                        <YAxis stroke="#808080" tick={{fill: '#808080', fontSize: 10}} tickLine={false} axisLine={{stroke: '#404040'}} label={{ value: 'Cost ($)', position: 'insideTopLeft', fill: '#808080', fontSize: 10, dy: -15 }} />
                                        <Tooltip content={<CustomTooltip />} />
                                        {showHoldingCost && <Area type="monotone" dataKey="cumHoldingCost" name="Holding Cost ($)" stackId="1" stroke="#8B5CF6" fillOpacity={1} fill="url(#colorHoldingCostDistributor)" />}
                                        {showBackorderCost && <Area type="monotone" dataKey="cumBackorderCost" name="Backorder Cost ($)" stackId="1" stroke="rgba(139, 92, 246, 0.9)" fillOpacity={1} fill="url(#colorBackorderCostDistributor)" />}
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT COLUMN - Metrics and Statistics Panels side-by-side */}
                    <div className="flex flex-col md:flex-row gap-4">
                        {/* Metrics Panel - Half Width */}
                        <div className="bg-mono-surface p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1 min-w-0 overflow-hidden">
                            <MetricsPanel gameData={data} />
                        </div>
                        {/* Statistics Panel - Half Width */}
                        <div className="bg-mono-surface p-4 rounded-xl border border-mono-light/20 shadow-lg flex flex-col flex-1 min-w-0">
                            <StatisticsPanel gameData={data} />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('charts-root'));
        root.render(<DashboardCharts />);
    </script>
</body></html>